{% extends 'base.html' %}

{% block title %}{{ year.name }} ({{ year.year }}) - IIHF Tabellenrechner{% endblock %}

{% block head_scripts %}
    {{ super() }} {# Falls es schon head_scripts in base.html gibt #}
    <style>
        .stats-section {
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: box-shadow 0.3s ease;
        }
        
        .stats-section:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .stats-title {
            color: #495057;
            border-bottom: 2px solid #6c757d;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        
        /* Dark mode improvements */
        body.dark-mode .stats-section {
            background-color: #2d3748;
            border-color: #4a5568;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        body.dark-mode .stats-section:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        
        body.dark-mode .stats-title {
            color: #e2e8f0;
            border-bottom-color: #a0aec0;
        }
        
        body.dark-mode .filter-section {
            background-color: #2d3748;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        
        body.dark-mode .table {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        
        body.dark-mode .table th,
        body.dark-mode .table td {
            border-color: #4a5568;
            color: #e2e8f0;
            background-color: transparent;
        }
        
        body.dark-mode .table .thead-dark th {
            background-color: #1a202c;
            border-color: #2d3748;
            color: #e2e8f0;
            font-weight: 600;
        }
        
        body.dark-mode .table .thead-light th {
            background-color: #4a5568;
            border-color: #4a5568;
            color: #e2e8f0;
            font-weight: 600;
        }
        
        body.dark-mode .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(255, 255, 255, 0.08) !important;
        }
        
        body.dark-mode .table-striped tbody tr:nth-of-type(even) {
            background-color: rgba(255, 255, 255, 0.03) !important;
        }
        
        body.dark-mode .table-hover tbody tr:hover {
            background-color: rgba(66, 153, 225, 0.15) !important;
        }
        
        body.dark-mode .table-success {
            background-color: rgba(34, 139, 34, 0.6) !important;
            border-color: rgba(34, 139, 34, 0.8) !important;
        }
        
        body.dark-mode .table-success td {
            color: #ffffff !important;
            font-weight: 600;
            background-color: rgba(34, 139, 34, 0.6) !important;
        }
        
        body.dark-mode .table-danger {
            background-color: rgba(178, 34, 34, 0.6) !important;
            border-color: rgba(178, 34, 34, 0.8) !important;
        }
        
        body.dark-mode .table-danger td {
            color: #ffffff !important;
            font-weight: 600;
            background-color: rgba(178, 34, 34, 0.6) !important;
        }
        
        body.dark-mode .table-success:hover td {
            color: #ffffff !important;
            background-color: rgba(34, 139, 34, 0.8) !important;
        }
        
        body.dark-mode .table-danger:hover td {
            color: #ffffff !important;
            background-color: rgba(178, 34, 34, 0.8) !important;
        }
        
        body.dark-mode .table td strong {
            color: #ffffff;
            font-weight: 700;
        }
        
        body.dark-mode .table-responsive {
            border: 1px solid #4a5568;
            border-radius: 8px;
            background-color: #2d3748;
        }
        
        body.dark-mode .fixed-table-layout {
            background-color: #2d3748;
        }
        
        /* Tabellenbreite optimieren für bessere Darstellung */
        .standings-table {
            width: 100%;
            table-layout: fixed;
            font-size: 1.0rem;
        }
        
        .standings-table th:nth-child(1) { width: 4%; }   /* # */
        .standings-table th:nth-child(2) { width: 20%; }  /* Team */
        .standings-table th:nth-child(3) { width: 5%; }   /* SP */
        .standings-table th:nth-child(4) { width: 5%; }   /* S */
        .standings-table th:nth-child(5) { width: 5%; }   /* OTS */
        .standings-table th:nth-child(6) { width: 5%; }   /* PS */
        .standings-table th:nth-child(7) { width: 5%; }   /* N */
        .standings-table th:nth-child(8) { width: 5%; }   /* OTN */
        .standings-table th:nth-child(9) { width: 5%; }   /* PN */
        .standings-table th:nth-child(10) { width: 15%; } /* Tore */
        .standings-table th:nth-child(11) { width: 8%; }  /* Diff */
        .standings-table th:nth-child(12) { width: 8%; }  /* Pkt */
        
        .standings-table th,
        .standings-table td {
            padding: 0.3rem 0.2rem;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .standings-table th:nth-child(2),
        .standings-table td:nth-child(2) {
            text-align: left;
            padding-left: 0.4rem;
        }
        
        /* Responsives Design für kleinere Bildschirme */
        @media (max-width: 1200px) {
            .standings-table {
                font-size: 0.8rem;
            }
            .standings-table th:nth-child(2) { width: 18%; }
            .standings-table th:nth-child(10) { width: 12%; }
        }
        
        @media (max-width: 768px) {
            .standings-table {
                font-size: 0.75rem;
            }
            .standings-table th,
            .standings-table td {
                padding: 0.2rem 0.1rem;
            }
        }
        
        body.dark-mode .card {
            background-color: #2d3748;
            border-color: #4a5568;
        }
        
        body.dark-mode .card-body {
            color: #e2e8f0;
        }
        
        body.dark-mode .nav-tabs .nav-link {
            color: #a0aec0;
            border-color: #4a5568;
        }
        
        body.dark-mode .nav-tabs .nav-link.active {
            color: #e2e8f0;
            background-color: #2d3748;
            border-color: #4a5568 #4a5568 #2d3748;
        }
        
        body.dark-mode .nav-tabs .nav-link:hover {
            border-color: #4a5568;
            color: #e2e8f0;
        }
        
        body.dark-mode .alert-warning {
            background-color: rgba(251, 176, 64, 0.2);
            border-color: #fbb040;
            color: #fbb040;
        }
        
        body.dark-mode .alert-info {
            background-color: rgba(66, 153, 225, 0.2);
            border-color: #4299e1;
            color: #4299e1;
        }
        
        body.dark-mode .alert-success {
            background-color: rgba(104, 211, 145, 0.2);
            border-color: #68d391;
            color: #68d391;
        }
        
        body.dark-mode .alert-danger {
            background-color: rgba(245, 101, 101, 0.2);
            border-color: #f56565;
            color: #f56565;
        }
        
        body.dark-mode .badge-success {
            background-color: #68d391 !important;
            color: #1a202c !important;
        }
        
        body.dark-mode .badge-danger {
            background-color: #f56565 !important;
            color: #1a202c !important;
        }
        
        body.dark-mode .text-muted {
            color: #a0aec0 !important;
        }
        
        body.dark-mode .form-group label {
            color: #e2e8f0;
        }
        
        body.dark-mode .form-control {
            background-color: #4a5568;
            border-color: #718096;
            color: #e2e8f0;
        }
        
        body.dark-mode .form-control:focus {
            background-color: #4a5568;
            border-color: #4299e1;
            color: #e2e8f0;
            box-shadow: 0 0 0 0.2rem rgba(66, 153, 225, 0.25);
        }
        
        body.dark-mode .form-control::placeholder {
            color: #a0aec0;
        }
        
        body.dark-mode .btn-primary {
            background-color: #4299e1;
            border-color: #4299e1;
        }
        
        body.dark-mode .btn-primary:hover {
            background-color: #3182ce;
            border-color: #3182ce;
        }
        
        body.dark-mode .btn-success {
            background-color: #68d391;
            border-color: #68d391;
            color: #1a202c;
        }
        
        body.dark-mode .btn-success:hover {
            background-color: #48bb78;
            border-color: #48bb78;
            color: #1a202c;
        }
        
        body.dark-mode .btn-warning {
            background-color: #fbb040;
            border-color: #fbb040;
            color: #1a202c;
        }
        
        body.dark-mode .btn-warning:hover {
            background-color: #ed8936;
            border-color: #ed8936;
            color: #1a202c;
        }
        
        body.dark-mode .btn-info {
            background-color: #4299e1;
            border-color: #4299e1;
            color: #1a202c;
        }
        
        body.dark-mode .btn-info:hover {
            background-color: #3182ce;
            border-color: #3182ce;
            color: #1a202c;
        }
        
        body.dark-mode .btn-danger {
            background-color: #f56565;
            border-color: #f56565;
            color: #1a202c;
        }
        
        body.dark-mode .btn-danger:hover {
            background-color: #e53e3e;
            border-color: #e53e3e;
            color: #1a202c;
        }
        
        body.dark-mode .btn-outline-secondary {
            color: #a0aec0;
            border-color: #a0aec0;
        }
        
        body.dark-mode .btn-outline-secondary:hover {
            background-color: #a0aec0;
            border-color: #a0aec0;
            color: #1a202c;
        }
        
        body.dark-mode .btn:disabled {
            opacity: 0.3 !important;
            cursor: not-allowed !important;
        }
        
        body.dark-mode .collapse .card {
            background-color: #1a202c;
        }
        
        body.dark-mode .list-group-item {
            background-color: #2d3748;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        
        body.dark-mode .list-group-item:hover {
            background-color: #4a5568;
        }
        
        body.dark-mode .list-group-flush .list-group-item {
            border-left: 0;
            border-right: 0;
            border-color: #4a5568;
        }
        
        body.dark-mode .event-item {
            border-left: 3px solid #4299e1;
        }
        
        body.dark-mode .event-time {
            color: #e2e8f0;
        }
        
        body.dark-mode .fas.fa-hockey-puck {
            color: #f56565 !important;
        }
        
        body.dark-mode .fas.fa-gavel {
            color: #4299e1 !important;
        }
        
        body.dark-mode small {
            color: #a0aec0;
        }
        
        /* Extra small button support */
        .btn-xs {
            padding: 0.125rem 0.25rem;
            font-size: 0.75rem;
            line-height: 1.2;
            border-radius: 0.15rem;
        }
        
        /* Dark mode for the time format help alerts */
        body.dark-mode .alert-info {
            background-color: rgba(66, 153, 225, 0.2);
            border-color: #4299e1;
            color: #4299e1;
        }
        
        body.dark-mode .alert-info code {
            background-color: rgba(0, 0, 0, 0.3);
            color: #e2e8f0;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
        }
        
        /* Dark mode styles for semifinal seeding section */
        body.dark-mode .card {
            background-color: #2d3748;
            border-color: #4a5568;
        }
        
        body.dark-mode .card-header {
            background-color: #1a202c;
            border-bottom-color: #4a5568;
            color: #e2e8f0;
        }
        
        body.dark-mode .list-group-item {
            background-color: #2d3748;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        
        body.dark-mode #newPairingsPreview {
            background-color: #4a5568 !important;
            border-color: #718096 !important;
            color: #e2e8f0;
        }
    </style>
    <script>
        var all_players_by_team_json_str = '{{ all_players_by_team_json|tojson|safe }}';
        var all_players_by_team_json = JSON.parse(all_players_by_team_json_str);
        var current_year_id_str = '{{ year.id|tojson|safe }}';
        var current_year_id = JSON.parse(current_year_id_str);
        
        // Make TEAM_ISO_CODES available to JavaScript
        var team_iso_codes_str = '{{ team_iso_codes|tojson|safe }}';
        window.TEAM_ISO_CODES_FROM_TEMPLATE = JSON.parse(team_iso_codes_str);
    </script>
{% endblock %}

{% block content %}
<h1>{{ year.name }} ({{ year.year }}) - Spielplan und Tabellen</h1>

{% if not year.fixture_path or not games_by_round %}
    <div class="alert alert-warning" role="alert">
        Für dieses Jahr wurde noch kein Spielplan hochgeladen oder der Spielplan ist leer.
        <a href="{{ url_for('main_bp.index') }}" class="alert-link">Zurück zur Startseite, um einen Spielplan hochzuladen.</a>
    </div>
{% else %}

    {# Tabs für Runden und Tabellen #}
    <ul class="nav nav-tabs mb-3" id="yearTabs" role="tablist">
        {% if standings %}
            <li class="nav-item" role="presentation">
                <a class="nav-link active" id="standings-tab" data-toggle="tab" href="#standings" role="tab" aria-controls="standings" aria-selected="true">Tabelle Gruppen</a>
            </li>
        {% endif %}
        {% for round_name, games_in_round in games_by_round.items() %}
            <li class="nav-item" role="presentation">
                <a class="nav-link {% if not standings and loop.first %}active{% endif %}" id="{{ round_name|replace(' ', '-')|lower }}-tab" data-toggle="tab" href="#{{ round_name|replace(' ', '-')|lower }}" role="tab" aria-controls="{{ round_name|replace(' ', '-')|lower }}" aria-selected="false">{{ round_name }} ({{ games_in_round|length }})</a>
            </li>
        {% endfor %}
        {# Statistics Tab #}
        {% if top_scorers_points or top_goal_scorers or top_assist_providers or top_penalty_players %}
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="statistics-tab" data-toggle="tab" href="#statistics" role="tab" aria-controls="statistics" aria-selected="false">Player Stats</a>
        </li>
        {% endif %}
        {# Team Stats Tab #}
        {% if team_stats_data %} {# Assumed variable from backend #}
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="team-stats-tab-link" data-toggle="tab" href="#team-stats" role="tab" aria-controls="team-stats" aria-selected="false">Team Stats</a>
        </li>
        {% endif %}
    </ul>

    <div class="tab-content" id="yearTabsContent">
        {# Tabellen Hauptrunde #}
        {% if standings %}
        <div class="tab-pane fade show active" id="standings" role="tabpanel" aria-labelledby="standings-tab">
            <h2>Tabellen der Hauptrunde</h2>
            <div class="row">
                {% for group_name, group_standings in standings.items() %}
                <div class="col-md-6 mb-4">
                    <h3>{{ group_name }}</h3>
                    {% if group_standings %}
                    <table class="table table-sm table-striped table-hover standings-table">
                        <thead class="thead-dark">
                            <tr>
                                <th>#</th>
                                <th>Team</th>
                                <th title="Spiele">SP</th>
                                <th title="Siege">S</th>
                                <th title="OT-Siege">OTS</th>
                                <th title="Penalty-Siege">PS</th>
                                <th title="Niederlagen">N</th>
                                <th title="OT-Niederlagen">OTN</th>
                                <th title="Penalty-Niederlagen">PN</th>
                                <th title="Tore">Tore</th>
                                <th title="Differenz">Diff.</th>
                                <th title="Punkte">Pkt.</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for team_stat in group_standings %}
                            {% set iso_code = team_iso_codes.get(team_stat.name) %}
                            <tr 
                                {% if loop.index <= 4 %} class="table-success" data-toggle="tooltip" title="Qualifiziert für Viertelfinale" {% endif %}
                                {% if loop.index == 8 %} class="table-danger" data-toggle="tooltip" title="Absteiger" {% endif %}
                            >
                                <td>{{ loop.index }}</td>
                                <td>
                                    {% if iso_code %}<img src="https://flagcdn.com/w20/{{ iso_code }}.png" alt="{{ team_stat.name }}" style="margin-right: 5px; vertical-align: middle;">{% endif %}
                                    {{ team_stat.name }}
                                </td>
                                <td>{{ team_stat.gp }}</td>
                                <td>{{ team_stat.w }}</td>
                                <td>{{ team_stat.otw }}</td>
                                <td>{{ team_stat.sow }}</td>
                                <td>{{ team_stat.l }}</td>
                                <td>{{ team_stat.otl }}</td>
                                <td>{{ team_stat.sol }}</td>
                                <td>{{ team_stat.gf }}:{{ team_stat.ga }}</td>
                                <td>{{ team_stat.gd }}</td>
                                <td><strong>{{ team_stat.pts }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p>Keine Daten für diese Gruppe vorhanden oder keine Spiele gespielt.</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <small class="form-text text-muted">
                Punkte: Sieg=3, OT/Penalty-Sieg=2, OT/Penalty-Niederlage=1. 
                <strong>Sortierung nach IIHF-Regeln:</strong> Punkte, dann bei Punktgleichheit:<br>
                • <strong>2 Teams:</strong> Direktes Duell entscheidet nur wenn gespielt, sonst Tordifferenz → Erzielte Tore<br>
                • <strong>3+ Teams:</strong> Head-to-Head nur wenn alle 7 Hauptrundenspiele gespielt, sonst Tordifferenz → Erzielte Tore<br>
                <span class="badge badge-success">&nbsp;</span> Top 4: Viertelfinale. 
                <span class="badge badge-danger">&nbsp;</span> Platz 8: Absteiger (können von den realen Absteigern abweichen).
            </small>
        </div>
        {% endif %}

        {# Spiele pro Runde #}
        {% for round_name, games_in_round in games_by_round.items() %}
        <div class="tab-pane fade {% if not standings and loop.first %}show active{% endif %}" id="{{ round_name|replace(' ', '-')|lower }}" role="tabpanel" aria-labelledby="{{ round_name|replace(' ', '-')|lower }}-tab">
            {% if round_name == 'Semifinals' %}
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>{{ round_name }}</h2>
                {% if games_in_round|length >= 2 %}
                    {% set sf_teams_resolved = [] %}
                    {% set sf_games_with_results = [] %}
                    {% for game in games_in_round %}
                        {% set p1_original_code = game.team1_code %}
                        {% set p2_original_code = game.team2_code %}
                        {% set p1_intermediate_code = playoff_team_map.get(p1_original_code, p1_original_code) %}
                        {% set p2_intermediate_code = playoff_team_map.get(p2_original_code, p2_original_code) %}
                        
                        {# Resolve team names #}
                        {% set p1_display_name = p1_intermediate_code %}
                        {% set p2_display_name = p2_intermediate_code %}
                        {% set standings_digits = "12345678" %}
                        {% set standings_groups = ['A', 'B', 'C', 'D'] %}
                        
                        {% if p1_intermediate_code and p1_intermediate_code|length == 2 and p1_intermediate_code[0] in standings_groups and p1_intermediate_code[1] in standings_digits %}
                            {% set group_letter = p1_intermediate_code[0] %}
                            {% set rank = (p1_intermediate_code[1] | int) - 1 %}
                            {% set group_name = "Group " + group_letter %}
                            {% if standings.get(group_name) and 0 <= rank < standings[group_name]|length %}
                                {% set p1_display_name = standings[group_name][rank].name %}
                            {% endif %}
                        {% endif %}
                        
                        {% if p2_intermediate_code and p2_intermediate_code|length == 2 and p2_intermediate_code[0] in standings_groups and p2_intermediate_code[1] in standings_digits %}
                            {% set group_letter = p2_intermediate_code[0] %}
                            {% set rank = (p2_intermediate_code[1] | int) - 1 %}
                            {% set group_name = "Group " + group_letter %}
                            {% if standings.get(group_name) and 0 <= rank < standings[group_name]|length %}
                                {% set p2_display_name = standings[group_name][rank].name %}
                            {% endif %}
                        {% endif %}
                            
                        {# Check if teams are resolved (not placeholders) #}
                        {% if team_iso_codes.get(p1_display_name) and team_iso_codes.get(p2_display_name) %}
                            {% do sf_teams_resolved.append(p1_display_name) %}
                            {% do sf_teams_resolved.append(p2_display_name) %}
                        {% endif %}
                        
                        {# Check if semifinal game has started (has score, goals, or penalties) #}
                        {% if game.team1_score is not none or game.team2_score is not none or game.goals|length > 0 or game.penalties|length > 0 %}
                            {% do sf_games_with_results.append(game.id) %}
                        {% endif %}
                    {% endfor %}
                    
                    {% if sf_teams_resolved|length >= 4 and sf_games_with_results|length == 0 %}
                    <button class="btn btn-outline-secondary btn-sm" type="button" data-toggle="collapse" data-target="#semifinalSeedingAdjust" aria-expanded="false" aria-controls="semifinalSeedingAdjust" id="adjustSeedingBtn">
                        <i class="fas fa-cogs"></i> Seeding Anpassen
                    </button>
                    {% elif sf_games_with_results|length > 0 %}
                    <button class="btn btn-outline-secondary btn-sm" disabled title="Seeding kann nicht mehr geändert werden - Semifinal-Spiele haben bereits begonnen">
                        <i class="fas fa-cogs"></i> Seeding Anpassen
                    </button>
                    {% else %}
                    <button class="btn btn-outline-secondary btn-sm" disabled title="Seeding kann erst angepasst werden, wenn alle Semifinal-Teams feststehen">
                        <i class="fas fa-cogs"></i> Seeding Anpassen
                    </button>
                    {% endif %}
                {% endif %}
            </div>
            
            {# Semifinal Seeding Adjustment Section #}
            {% if games_in_round|length >= 2 and sf_teams_resolved|length >= 4 and sf_games_with_results|length == 0 %}
            <div class="collapse mb-4" id="semifinalSeedingAdjust">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-trophy"></i> Semifinal Seeding Anpassung
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="seedingMessageArea" class="mb-3"></div>
                        
                        <div class="alert alert-info" role="alert">
                            <i class="fas fa-info-circle"></i>
                            <strong>Standard Seeding:</strong> 1. Seed vs 4. Seed, 2. Seed vs 3. Seed<br>
                            <small class="text-muted">Das Seeding basiert auf der Gruppenplatzierung (Gruppenrang → Punkte → Tordifferenz → Erzielte Tore)</small>
                        </div>
                        
                        <form id="adjustSeedingForm">
                            <input type="hidden" name="year_id" value="{{ year.id }}">
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Aktuelles Seeding:</h6>
                                    <div id="currentSeedingDisplay">
                                        {# This will be populated by JavaScript #}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Neues Seeding:</h6>
                                    <div class="form-group">
                                        <label for="seed1">1. Seed:</label>
                                        <select class="form-control form-control-sm" name="seed1" id="seed1" required>
                                            <option value="">Team wählen...</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="seed2">2. Seed:</label>
                                        <select class="form-control form-control-sm" name="seed2" id="seed2" required>
                                            <option value="">Team wählen...</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="seed3">3. Seed:</label>
                                        <select class="form-control form-control-sm" name="seed3" id="seed3" required>
                                            <option value="">Team wählen...</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="seed4">4. Seed:</label>
                                        <select class="form-control form-control-sm" name="seed4" id="seed4" required>
                                            <option value="">Team wählen...</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <strong>Neue Semifinal-Paarungen:</strong>
                                <div id="newPairingsPreview" class="mt-2 p-2 bg-light border rounded">
                                    <div id="pairing1">Spiel 1: <span class="font-weight-bold" id="seed1Display">-</span> vs <span class="font-weight-bold" id="seed4Display">-</span></div>
                                    <div id="pairing2">Spiel 2: <span class="font-weight-bold" id="seed2Display">-</span> vs <span class="font-weight-bold" id="seed3Display">-</span></div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <i class="fas fa-save"></i> Seeding Speichern
                                </button>
                                <button type="button" class="btn btn-secondary btn-sm ml-2" id="resetSeedingBtn">
                                    <i class="fas fa-undo"></i> Zurücksetzen
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm ml-2" data-toggle="collapse" data-target="#semifinalSeedingAdjust">
                                    Abbrechen
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}
            {% else %}
            <h2>{{ round_name }}</h2>
            {% endif %}
            
            {% if games_in_round %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead class="thead-light">
                        <tr>
                            <th>Nr.</th>
                            <th>Datum</th>
                            <th>Zeit</th>
                            {% if round_name == "Preliminary Round" %}<th>Gr.</th>{% endif %}
                            <th>Heim</th>
                            <th>VS</th>
                            <th>Gast</th>
                            <th colspan="3" class="text-center">Ergebnis</th>
                            <th>Ort</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for game in games_in_round %}
                        {# Resolve team codes using playoff_team_map #}
                        {% set p1_original_code = game.team1_code %}
                        {% set p2_original_code = game.team2_code %}

                        {% set p1_intermediate_code = playoff_team_map.get(p1_original_code, p1_original_code) %}
                        {% set p2_intermediate_code = playoff_team_map.get(p2_original_code, p2_original_code) %}


                        {# --- Logic to resolve standings placeholders like "1A" for Team 1 --- #}
                        {% set p1_display_name = p1_intermediate_code %}
                        {% set p1_display_iso = team_iso_codes.get(p1_display_name) %}
                        {% set standings_digits = "12345678" %} {# Assuming max 8 teams for rank #}
                        {% set standings_groups = ['A', 'B', 'C', 'D'] %} {# Add more group letters if needed #}
                        {% if p1_intermediate_code and p1_intermediate_code|length == 2 and p1_intermediate_code[0] in standings_groups and p1_intermediate_code[1] in standings_digits %}
                            {% set group_letter = p1_intermediate_code[0] %}
                            {% set rank = (p1_intermediate_code[1] | int) - 1 %} {# 0-indexed #}
                            {% set group_name = "Group " + group_letter %}
                            {% if standings.get(group_name) and 0 <= rank < standings[group_name]|length %}
                                {% set p1_display_name = standings[group_name][rank].name %}
                                {% set p1_display_iso = team_iso_codes.get(p1_display_name) %}
                            {% endif %}
                        {% endif %}

                        {# --- Logic to resolve standings placeholders like "1A" for Team 2 --- #}
                        {% set p2_display_name = p2_intermediate_code %}
                        {% set p2_display_iso = team_iso_codes.get(p2_display_name) %}
                        {% if p2_intermediate_code and p2_intermediate_code|length == 2 and p2_intermediate_code[0] in standings_groups and p2_intermediate_code[1] in standings_digits %}
                            {% set group_letter = p2_intermediate_code[0] %}
                            {% set rank = (p2_intermediate_code[1] | int) - 1 %} {# 0-indexed #}
                            {% set group_name = "Group " + group_letter %}
                            {% if standings.get(group_name) and 0 <= rank < standings[group_name]|length %}
                                {% set p2_display_name = standings[group_name][rank].name %}
                                {% set p2_display_iso = team_iso_codes.get(p2_display_name) %}
                            {% endif %}
                        {% endif %}

                        <tr id="game-{{ game.id }}">
                            <td>{{ game.game_number }}</td>
                            <td>{{ game.date.split('-') | reverse | join('.') if game.date else '-' }}</td>
                            <td>{{ game.start_time.split(' ')[0] if game.start_time else '-' }}</td>
                            {% if round_name == "Preliminary Round" %}<td>{{ game.group.replace('Group ', '') if game.group else 'N/A' }}</td>{% endif %}
                            <td>
                                {% if p1_display_iso %}<img src="https://flagcdn.com/w20/{{ p1_display_iso }}.png" alt="{{ p1_display_name }}" style="margin-right: 5px; vertical-align: middle;">{% endif %}
                                {% if game.team1_score is not none and game.team2_score is not none and game.team1_points > game.team2_points %}<strong>{% endif %}
                                {{ p1_display_name }}
                                {% if game.team1_score is not none and game.team2_score is not none and game.team1_points > game.team2_points %}</strong>{% endif %}
                                {# Condition to show the original placeholder in (parentheses) #}
                                {% set show_p1_original_placeholder = False %}
                                {% if p1_original_code != p1_display_name %} {# If there was a change #}
                                    {% if (p1_original_code in ['Q1', 'Q2', 'Q3', 'Q4'] or
                                           (p1_original_code|string).startswith('W(') or
                                           (p1_original_code|string).startswith('L(')) %}
                                        {# For QF/WL placeholders, if it changed, we DON'T show the original #}
                                        {% set show_p1_original_placeholder = False %}
                                    {% else %}
                                        {# For other placeholders like A1, B2, etc., if it changed, we DO show the original #}
                                        {% set show_p1_original_placeholder = True %}
                                    {% endif %}
                                {% endif %}
                                {% if show_p1_original_placeholder %}
                                    <small class="text-muted">({{ p1_original_code }})</small>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {# Direktvergleich Button - nur für echte Teams (nicht Platzhalter) #}
                                {% if team_iso_codes.get(p1_display_name.upper()) and team_iso_codes.get(p2_display_name.upper()) %}
                                    {# Prüfung ob es bereits Duelle zwischen den Teams gab #}
                                    {% set team_pair_key = [p1_display_name, p2_display_name]|sort|join('_vs_') %}
                                    {% set has_previous_games = team_combinations_with_games.get(team_pair_key, False) %}
                                    {% if has_previous_games %}
                                        <button type="button" data-url="{{ url_for('year_bp.team_vs_team_view', year_id=year.id, team1=p1_display_name, team2=p2_display_name) }}" data-window-name="direktvergleich_{{ p1_display_name }}_{{ p2_display_name }}" class="btn btn-secondary btn-sm team-vs-team-link" title="Direktvergleich anzeigen">
                                            <i class="fas fa-balance-scale"></i>
                                        </button>
                                    {% else %}
                                        <button type="button" class="btn btn-secondary btn-sm" disabled style="opacity: 0.3; cursor: not-allowed;" title="Noch keine direkten Duelle zwischen diesen Teams">
                                            <i class="fas fa-balance-scale"></i>
                                        </button>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                                {% if p2_display_iso %}<img src="https://flagcdn.com/w20/{{ p2_display_iso }}.png" alt="{{ p2_display_name }}" style="margin-right: 5px; vertical-align: middle;">{% endif %}
                                {% if game.team1_score is not none and game.team2_score is not none and game.team2_points > game.team1_points %}<strong>{% endif %}
                                {{ p2_display_name }}
                                {% if game.team1_score is not none and game.team2_score is not none and game.team2_points > game.team1_points %}</strong>{% endif %}
                                {# Condition to show the original placeholder in (parentheses) #}
                                {% set show_p2_original_placeholder = False %}
                                {% if p2_original_code != p2_display_name %} {# If there was a change #}
                                    {% if (p2_original_code in ['Q1', 'Q2', 'Q3', 'Q4'] or
                                           (p2_original_code|string).startswith('W(') or
                                           (p2_original_code|string).startswith('L(')) %}
                                        {# For QF/WL placeholders, if it changed, we DON'T show the original #}
                                        {% set show_p2_original_placeholder = False %}
                                    {% else %}
                                        {# For other placeholders like A1, B2, etc., if it changed, we DO show the original #}
                                        {% set show_p2_original_placeholder = True %}
                                    {% endif %}
                                {% endif %}
                                {% if show_p2_original_placeholder %}
                                    <small class="text-muted">({{ p2_original_code }})</small>
                                {% endif %}
                            </td>
                            <form method="POST" action="{{ url_for('year_bp.year_view', year_id=year.id) }}#game-{{game.id}}">
                                <input type="hidden" name="game_id" value="{{ game.id }}">
                                <td style="width: 70px;">
                                    <input type="number" name="team1_score" class="form-control form-control-sm" value="{{ game.team1_score if game.team1_score is not none else '' }}" min="0">
                                </td>
                                <td style="width: 70px;">
                                    <input type="number" name="team2_score" class="form-control form-control-sm" value="{{ game.team2_score if game.team2_score is not none else '' }}" min="0">
                                </td>
                                <td style="width: 130px;">
                                    <select name="result_type" class="form-control form-control-sm">
                                        <option value="REG" {% if game.result_type == 'REG' %}selected{% endif %}>Regulär</option>
                                        <option value="OT" {% if game.result_type == 'OT' %}selected{% endif %}>n.V.</option>
                                        <option value="SO" {% if game.result_type == 'SO' %}selected{% endif %}>n.P.</option>
                                    </select>
                                </td>
                                <td>{{ game.location }}</td>
                                <td class="text-nowrap"> {# Aktion Zelle #}
                                    <button type="submit" class="btn btn-success btn-sm mr-1">Speichern</button>
                                    {# Stats Button #}
                                    <a href="{{ url_for('year_bp.game_stats_view', year_id=year.id, game_id=game.id) }}" class="btn btn-warning btn-sm mr-1 game-stats-link" title="Spielstatistik anzeigen">
                                        <i class="fas fa-chart-bar"></i> Stats
                                    </a>
                                    {# Main Details Button - formerly Goals Button #}
                                    <button class="btn btn-info btn-sm mr-1" type="button" data-toggle="collapse" data-target="#game-details-{{ game.id }}" aria-expanded="false" aria-controls="game-details-{{ game.id }}"
                                            title="Spiel Details, Tore und Strafen">
                                        <i class="fas fa-clipboard-list"></i> Details <span class="badge badge-light" id="eventCountBadge-{{ game.id }}">{{ game.sorted_events|length }}</span>
                                    </button>
                                    {# Indikator für Torübereinstimmung - this might need to be re-evaluated or moved if goals are not directly editable in the main game row anymore #}
                                    <span id="scoreMatchIndicatorContainer-{{ game.id }}">
                                    {% if game.team1_score is not none or game.team2_score is not none %} {# Nur anzeigen, wenn mind. ein Score gesetzt ist #}
                                        {% if game.overrule %}
                                            <span class="text-warning score-match-indicator overruled-indicator" data-game-id="{{ game.id }}" style="cursor: pointer;" title="Score-Matching überregelt: {{ game.overrule.reason }}">
                                                <i class="fas fa-exclamation-triangle"></i>
                                            </span>
                                        {% elif game.scores_fully_match_goals %}
                                            <span class="text-success score-match-indicator valid-indicator" data-game-id="{{ game.id }}" title="Spielstand, erfasste Tore, SOG-Daten und Powerplay-Situationen sind vollständig und korrekt. Overtime-Regeln und Penalty-Sonderregeln (5+Spieldauer, 2+2 Min) beachtet.">✓</span>
                                        {% else %}
                                            <span class="text-danger score-match-indicator invalid-indicator" data-game-id="{{ game.id }}" style="cursor: pointer;" title="Spielstand und erfasste Tore stimmen NICHT überein, SOG-Daten fehlen für P1-P3, Overtime-Regeln verletzt (Tore nach 60:00 erfordern n.V. und Tordifferenz von 1), oder Powerplay-/Penalty-Situationen sind inkonsistent (PP/SH-Tore bei aktiven Strafen, Sonderregeln für 5+Spieldauer und 2+2 Min beachtet). Klicken zum Überregeln.">✗</span>
                                        {% endif %}
                                    {% endif %}
                                    </span>
                                </td>
                            </form>
                        </tr>
                        {# Combined Row for Game Details (Events, Goal/Penalty Entry) - Collapsible #}
                        <tr class="game-details-row"> {# Consolidated row for all details #}
                            <td colspan="100%">
                                <div class="collapse" id="game-details-{{ game.id }}">
                                    <div class="card card-body">
                                        <h5>Spiel-Chronik für {{ game.game_number }}: {{ p1_display_name }} vs {{ p2_display_name }}</h5>
                                        
                                        <div id="gameEventsDisplayArea-{{ game.id }}" class="mt-2 game-events-timeline mb-3">
                                            {% if game.sorted_events %}
                                                <ul class="list-group list-group-flush">
                                                    {# Removed all period header, start/end marker logic and flags #}
                                                    {% for event in game.sorted_events %}
                                                        {# Actual Event Item #}
                                                        <li class="list-group-item event-item">
                                                            <div class="d-flex w-100 justify-content-between">
                                                                <h6 class="mb-1 event-time">
                                                                    {% if event.type == 'goal' %}
                                                                        <i class="fas fa-hockey-puck text-danger mr-2"></i>
                                                                    {% elif event.type == 'penalty' %}
                                                                        <i class="fas fa-gavel text-primary mr-2"></i>
                                                                    {% endif %}
                                                                    {{ event.time_str }}
                                                                </h6>
                                                                <small>
                                                                    {% if event.type == 'goal' %}
                                                                        <form method="POST" action="{{ url_for('year_bp.delete_goal', year_id=year.id, goal_id=event.data.id) }}" style="display: inline;" class="delete-event-form">
                                                                            <input type="hidden" name="game_id_event_delete" value="{{ game.id }}">
                                                                            <button type="submit" class="btn btn-danger btn-xs ml-2" title="Tor löschen">×</button>
                                                                        </form>
                                                                    {% elif event.type == 'penalty' %}
                                                                        <form method="POST" action="{{ url_for('year_bp.delete_penalty', year_id=year.id, penalty_id=event.data.id) }}" style="display: inline;" class="delete-event-form">
                                                                            <input type="hidden" name="game_id_event_delete" value="{{ game.id }}">
                                                                            <button type="submit" class="btn btn-danger btn-xs ml-2" title="Strafe löschen">×</button>
                                                                        </form>
                                                                    {% endif %}
                                                                </small>
                                                            </div>
                                                            {% if event.type == 'goal' %}
                                                                <p class="mb-1">
                                                                    <strong>Tor! {{ event.data.team_code }}</strong>
                                                                    {% set goal_details = [] %}
                                                                    {% if event.data.goal_type_display != 'REG' and event.data.goal_type_display %}
                                                                        {% do goal_details.append(event.data.goal_type_display) %}
                                                                    {% elif event.data.goal_type_display == 'REG' and not event.data.is_empty_net %}
                                                                        {% do goal_details.append("EQ") %}
                                                                    {% endif %}
                                                                    {% if event.data.is_empty_net %}
                                                                        {% do goal_details.append("EN") %}
                                                                    {% endif %}
                                                                    {% if goal_details %}
                                                                        ({{ goal_details|join(', ') }})
                                                                    {% endif %}<br>
                                                                    Torschütze: {{ event.data.scorer }} {# Corrected #}
                                                                    {% if event.data.assist1 %}<br>Assist 1: {{ event.data.assist1 }}{% endif %} {# Corrected #}
                                                                    {% if event.data.assist2 %}<br>Assist 2: {{ event.data.assist2 }}{% endif %} {# Corrected #}
                                                                </p>
                                                            {% elif event.type == 'penalty' %}
                                                                <p class="mb-1">
                                                                    <strong>{{ event.data.penalty_type }} Strafe für {{ event.data.team_code }}</strong><br>
                                                                    {{ event.data.player_name }} {# Corrected #}
                                                                    Grund: {{ event.data.reason }}
                                                                </p>
                                                            {% endif %}
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            {% else %}
                                                <p class="text-muted mt-2" id="noGameEventsMessage-{{ game.id }}">Noch keine Tore oder Strafen für dieses Spiel erfasst.</p>
                                            {% endif %}
                                        </div>
                                        
                                        {# Goal and Penalty Entry Forms within the same card section #}
                                        <hr>
                                        <div id="goalMessageArea-{{ game.id }}" class="mt-2"></div>
                                        <h6>Neues Tor hinzufügen 
                                            <small>
                                                <button type="button" class="btn btn-outline-info btn-xs ml-2" data-toggle="collapse" data-target="#timeFormatHelp-{{game.id}}" aria-expanded="false">
                                                    <i class="fas fa-question-circle"></i> Zeitformate
                                                </button>
                                            </small>
                                        </h6>
                                        <div class="collapse" id="timeFormatHelp-{{game.id}}">
                                            <div class="alert alert-info small mb-3">
                                                <strong>Eingabeformate für Spielzeit:</strong><br>
                                                • <code>01:23</code> - Standard mm:ss (1:23 im Spiel)<br>
                                                • <code>1-5:13</code> - 1. Drittel, 5:13 verbleibend (= 14:47)<br>
                                                • <code>2+10:35</code> - 2. Drittel, 10:35 vergangen (= 30:35)<br>
                                                • <code>O5-1:23</code> - 5min OT, 1:23 verbleibend (= 63:37)<br>
                                                • <code>O10+3:45</code> - 10min OT, 3:45 vergangen (= 63:45)
                                            </div>
                                        </div>
                                        <form method="POST" action="{{ url_for('year_bp.add_goal', year_id=year.id, game_id=game.id) }}" id="addGoalForm-{{ game.id }}" class="mb-4">
                                            {# ... Goal form fields ... (content is the same, just ensure IDs are unique if needed) ... #}
                                            <input type="hidden" name="game_id" value="{{ game.id }}">
                                            <div class="form-row">
                                                                                <div class="form-group col-md-2">
                                    <label for="goal_minute-{{game.id}}">Minute</label>
                                    <input type="text" class="form-control form-control-sm" name="minute" id="goal_minute-{{game.id}}" placeholder="01:23 oder 1-5:13" required title="Eingabeformate: mm:ss (01:23), Drittel verbleibend (1-5:13), Drittel vergangen (2+10:35), OT verbleibend (O5-1:23), OT vergangen (O10+3:45)">
                                </div>
                                                <div class="form-group col-md-2">
                                                    <label for="goal_team-{{game.id}}">Team</label>
                                                    <select name="team_code_goal" id="goal_team-{{game.id}}" class="form-control form-control-sm goal-team-select" required>
                                                        <option value="{{ p1_display_name }}">{{ p1_display_name }}</option>
                                                        <option value="{{ p2_display_name }}">{{ p2_display_name }}</option>
                                                    </select>
                                                </div>
                                                <div class="form-group col-md-2">
                                                    <label for="goal_type-{{game.id}}">Typ</label>
                                                    <select name="goal_type" id="goal_type-{{game.id}}" class="form-control form-control-sm" required>
                                                        <option value="REG">EQ (Regular)</option>
                                                        <option value="PP">PP (Power Play)</option>
                                                        <option value="SH">SH (Short Handed)</option>
                                                        <option value="PS">PS (Penalty Shot)</option>
                                                    </select>
                                                </div>
                                                <div class="form-group col-md-2 d-flex align-items-end pb-1 ml-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="is_empty_net" id="goal_is_empty_net-{{game.id}}">
                                                        <label class="form-check-label" for="goal_is_empty_net-{{game.id}}">EN (Empty Net)</label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="form-group col-md-3">
                                                    <label for="scorer-{{game.id}}">Torschütze</label>
                                                    <select name="scorer_id" id="scorer-{{game.id}}" class="form-control form-control-sm player-select" data-team-select="#goal_team-{{game.id}}" required>
                                                        <option value="">Spieler wählen...</option>
                                                    </select>
                                                </div>
                                                <div class="form-group col-md-3">
                                                    <label for="assist1-{{game.id}}">Assist 1 (optional)</label>
                                                    <select name="assist1_id" id="assist1-{{game.id}}" class="form-control form-control-sm player-select" data-team-select="#goal_team-{{game.id}}">
                                                        <option value="">Spieler wählen...</option>
                                                    </select>
                                                </div>
                                                <div class="form-group col-md-3">
                                                    <label for="assist2-{{game.id}}">Assist 2 (optional)</label>
                                                    <select name="assist2_id" id="assist2-{{game.id}}" class="form-control form-control-sm player-select" data-team-select="#goal_team-{{game.id}}">
                                                        <option value="">Spieler wählen...</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <button type="submit" class="btn btn-primary btn-sm">Tor speichern</button>
                                        </form>

                                        <hr>
                                        <div id="penaltyMessageArea-{{ game.id }}" class="mt-2"></div>
                                        <h6>Neue Strafe hinzufügen 
                                            <small>
                                                <button type="button" class="btn btn-outline-info btn-xs ml-2" data-toggle="collapse" data-target="#timeFormatHelpPenalty-{{game.id}}" aria-expanded="false">
                                                    <i class="fas fa-question-circle"></i> Zeitformate
                                                </button>
                                            </small>
                                        </h6>
                                        <div class="collapse" id="timeFormatHelpPenalty-{{game.id}}">
                                            <div class="alert alert-info small mb-3">
                                                <strong>Eingabeformate für Spielzeit:</strong><br>
                                                • <code>01:23</code> - Standard mm:ss (1:23 im Spiel)<br>
                                                • <code>1-5:13</code> - 1. Drittel, 5:13 verbleibend (= 14:47)<br>
                                                • <code>2+10:35</code> - 2. Drittel, 10:35 vergangen (= 30:35)<br>
                                                • <code>O5-1:23</code> - 5min OT, 1:23 verbleibend (= 63:37)<br>
                                                • <code>O10+3:45</code> - 10min OT, 3:45 vergangen (= 63:45)
                                            </div>
                                        </div>
                                        <form method="POST" action="{{ url_for('year_bp.add_penalty', year_id=year.id, game_id=game.id) }}" id="addPenaltyForm-{{ game.id }}" class="mb-4">
                                            {# ... Penalty form fields ... (content is the same) ... #}
                                            <input type="hidden" name="game_id" value="{{ game.id }}">
                                            <div class="form-row">
                                                                                <div class="form-group col-md-2">
                                    <label for="penalty_minute-{{game.id}}">Minute</label>
                                    <input type="text" class="form-control form-control-sm" name="minute_of_game" id="penalty_minute-{{game.id}}" placeholder="01:23 oder 2+10:35" required title="Eingabeformate: mm:ss (01:23), Drittel verbleibend (1-5:13), Drittel vergangen (2+10:35), OT verbleibend (O5-1:23), OT vergangen (O10+3:45)">
                                </div>
                                                <div class="form-group col-md-3">
                                                    <label for="penalty_team-{{game.id}}">Team</label>
                                                    <select name="team_code_penalty" id="penalty_team-{{game.id}}" class="form-control form-control-sm penalty-team-select" required>
                                                        <option value="{{ p1_display_name }}">{{ p1_display_name }}</option>
                                                        <option value="{{ p2_display_name }}">{{ p2_display_name }}</option>
                                                    </select>
                                                </div>
                                                <div class="form-group col-md-4">
                                                    <label for="penalty_player-{{game.id}}">Spieler (oder Teamstrafe)</label>
                                                    <select name="player_id_penalty" id="penalty_player-{{game.id}}" class="form-control form-control-sm penalty-player-select" data-team-select="#penalty_team-{{game.id}}">
                                                        <option value="">Spieler wählen...</option>
                                                        <option value="-1">Teamstrafe</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="form-group col-md-3">
                                                    <label for="penalty_type-{{game.id}}">Strafmaß</label>
                                                    <select name="penalty_type" id="penalty_type-{{game.id}}" class="form-control form-control-sm" required>
                                                        {% for p_type in penalty_types %}
                                                        <option value="{{ p_type }}">{{ p_type }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="form-group col-md-3">
                                                    <label for="penalty_reason-{{game.id}}">Grund</label>
                                                    <select class="form-control form-control-sm" name="reason" id="penalty_reason-{{game.id}}" required>
                                                        <option value="" disabled selected>Bitte wählen...</option>
                                                        {% for reason in penalty_reasons %}
                                                            <option value="{{ reason }}">{{ reason }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                            <button type="submit" class="btn btn-primary btn-sm">Strafe speichern</button>
                                        </form>
                                        
                                        <hr>
                                        <div id="messageArea-{{ game.id }}" class="mt-2"></div>
                                        <h6>Neuen Spieler hinzufügen (zum Kader)</h6>
                                        <form method="POST" action="{{ url_for('year_bp.add_player') }}" class="mt-2" id="addPlayerForm-{{ game.id }}">
                                            {# ... Add Player form fields ... (content is the same) ... #}
                                            <input type="hidden" name="game_id_anchor" value="{{ game.id }}">
                                            <input type="hidden" name="year_id_redirect" value="{{ year.id }}">
                                            <div class="form-row">
                                                <div class="form-group col-md-3">
                                                    <label for="player_first_name-{{game.id}}">Vorname</label>
                                                    <input type="text" class="form-control form-control-sm" name="first_name" id="player_first_name-{{game.id}}" required>
                                                </div>
                                                <div class="form-group col-md-3">
                                                    <label for="player_last_name-{{game.id}}">Nachname</label>
                                                    <input type="text" class="form-control form-control-sm" name="last_name" id="player_last_name-{{game.id}}" required>
                                                </div>
                                                <div class="form-group col-md-2">
                                                    <label for="player_jersey_number-{{game.id}}">Nr. (optional)</label>
                                                    <input type="number" class="form-control form-control-sm" name="jersey_number" id="player_jersey_number-{{game.id}}" min="0" max="99">
                                                </div>
                                                <div class="form-group col-md-3">
                                                    <label for="player_team_code-{{game.id}}">Team</label>
                                                    <select name="team_code" id="player_team_code-{{game.id}}" class="form-control form-control-sm" required>
                                                        <option value="">Team wählen...</option>
                                                        {% for team_code_key, iso_val in team_codes.items()|sort %}
                                                            {% if iso_val %} {# Only include teams with a valid ISO code (not placeholders like QF) #}
                                                                <option value="{{ team_code_key }}">{{ team_code_key }}</option>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                            <button type="submit" class="btn btn-primary btn-sm">Spieler hinzufügen</button>
                                        </form>

                                        {# --- START OF SHOTS ON GOAL (SOG) SECTION --- #}
                                        <hr class="my-4">
                                        <h5>Schüsse aufs Tor (SOG)</h5>
                                        <div id="sogMessageArea-{{ game.id }}" class="mt-2"></div> {# ADDED SOG Message Area #}
                                        {# SOG Display Table / Becomes Edit Form #}
                                        {# Only show SOG form if team codes are actual teams (not placeholders) #}
                                        {% if team_iso_codes.get(p1_display_name) and team_iso_codes.get(p2_display_name) %}
                                        <form id="sogEditForm-{{ game.id }}" class="sog-edit-form"> {# New Form Wrapper #}
                                            <input type="hidden" name="sog_team1_code_resolved" value="{{ p1_display_name }}">
                                            <input type="hidden" name="sog_team2_code_resolved" value="{{ p2_display_name }}">
                                            <div id="sogDisplayTableContainer-{{ game.id }}" class="mb-3">
                                                <table class="table table-sm table-bordered text-center" style="width: auto;">
                                                    <thead class="thead-light">
                                                        <tr>
                                                            <th>Team</th>
                                                            <th>P1</th>
                                                            <th>P2</th>
                                                            <th>P3</th>
                                                            <th>OT</th>
                                                            <th>Gesamt</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {# Team 1 SOG Display #}
                                                        {% set team1_sog = game.sog_data.get(p1_display_name, {}) %}
                                                        {% set team1_p1_sog = team1_sog.get(1, 0) %}
                                                        {% set team1_p2_sog = team1_sog.get(2, 0) %}
                                                        {% set team1_p3_sog = team1_sog.get(3, 0) %}
                                                        {% set team1_p4_sog = team1_sog.get(4, 0) %}
                                                        {% set team1_total_sog = team1_p1_sog + team1_p2_sog + team1_p3_sog + team1_p4_sog %}
                                                        <tr>
                                                            <td>
                                                                {% set t1_iso = team_iso_codes.get(p1_display_name) %}
                                                                {% if t1_iso %}<img src="https://flagcdn.com/w20/{{ t1_iso }}.png" alt="" style="margin-right: 3px;">{% endif %}
                                                                {{ p1_display_name }}
                                                            </td>
                                                            <td><input type="number" class="form-control form-control-sm sog-inline-edit" name="team1_p1_shots" value="{{ team1_p1_sog }}" min="0" style="width: 60px;"></td>
                                                            <td><input type="number" class="form-control form-control-sm sog-inline-edit" name="team1_p2_shots" value="{{ team1_p2_sog }}" min="0" style="width: 60px;"></td>
                                                            <td><input type="number" class="form-control form-control-sm sog-inline-edit" name="team1_p3_shots" value="{{ team1_p3_sog }}" min="0" style="width: 60px;"></td>
                                                            <td><input type="number" class="form-control form-control-sm sog-inline-edit" name="team1_p4_shots" value="{{ team1_p4_sog }}" min="0" style="width: 60px;"></td>
                                                            <td id="sog-{{ game.id }}-{{ p1_display_name }}-total-display"><strong>{{ team1_total_sog }}</strong></td>
                                                        </tr>
                                                        {# Team 2 SOG Display #}
                                                        {% set team2_sog = game.sog_data.get(p2_display_name, {}) %}
                                                        {% set team2_p1_sog = team2_sog.get(1, 0) %}
                                                        {% set team2_p2_sog = team2_sog.get(2, 0) %}
                                                        {% set team2_p3_sog = team2_sog.get(3, 0) %}
                                                        {% set team2_p4_sog = team2_sog.get(4, 0) %}
                                                        {% set team2_total_sog = team2_p1_sog + team2_p2_sog + team2_p3_sog + team2_p4_sog %}
                                                        <tr>
                                                            <td>
                                                                {% set t2_iso = team_iso_codes.get(p2_display_name) %}
                                                                {% if t2_iso %}<img src="https://flagcdn.com/w20/{{ t2_iso }}.png" alt="" style="margin-right: 3px;">{% endif %}
                                                                {{ p2_display_name }}
                                                            </td>
                                                            <td><input type="number" class="form-control form-control-sm sog-inline-edit" name="team2_p1_shots" value="{{ team2_p1_sog }}" min="0" style="width: 60px;"></td>
                                                            <td><input type="number" class="form-control form-control-sm sog-inline-edit" name="team2_p2_shots" value="{{ team2_p2_sog }}" min="0" style="width: 60px;"></td>
                                                            <td><input type="number" class="form-control form-control-sm sog-inline-edit" name="team2_p3_shots" value="{{ team2_p3_sog }}" min="0" style="width: 60px;"></td>
                                                            <td><input type="number" class="form-control form-control-sm sog-inline-edit" name="team2_p4_shots" value="{{ team2_p4_sog }}" min="0" style="width: 60px;"></td>
                                                            <td id="sog-{{ game.id }}-{{ p2_display_name }}-total-display"><strong>{{ team2_total_sog }}</strong></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <button type="submit" class="btn btn-primary btn-sm mt-2 mb-3">SOG Speichern</button>
                                        </form>
                                        {% else %}
                                        {# SOG Display Table (Read-only version if teams are placeholders) #}
                                        <div id="sogDisplayTableContainer-{{ game.id }}" class="mb-3">
                                            <table class="table table-sm table-bordered text-center" style="width: auto;">
                                                <thead class="thead-light">
                                                    <tr>
                                                        <th>Team</th>
                                                        <th>P1</th>
                                                        <th>P2</th>
                                                        <th>P3</th>
                                                        <th>OT</th>
                                                        <th>Gesamt</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {# Team 1 SOG Display #}
                                                    {% set team1_sog = game.sog_data.get(p1_display_name, {}) %}
                                                    {% set team1_p1_sog = team1_sog.get(1, 0) %}
                                                    {% set team1_p2_sog = team1_sog.get(2, 0) %}
                                                    {% set team1_p3_sog = team1_sog.get(3, 0) %}
                                                    {% set team1_p4_sog = team1_sog.get(4, 0) %}
                                                    {% set team1_total_sog = team1_p1_sog + team1_p2_sog + team1_p3_sog + team1_p4_sog %}
                                                    <tr>
                                                        <td>
                                                            {% set t1_iso = team_iso_codes.get(p1_display_name) %}
                                                            {% if t1_iso %}<img src="https://flagcdn.com/w20/{{ t1_iso }}.png" alt="" style="margin-right: 3px;">{% endif %}
                                                            {{ p1_display_name }}
                                                        </td>
                                                        <td id="sog-{{ game.id }}-{{ p1_display_name }}-p1-display">{{ team1_p1_sog }}</td>
                                                        <td id="sog-{{ game.id }}-{{ p1_display_name }}-p2-display">{{ team1_p2_sog }}</td>
                                                        <td id="sog-{{ game.id }}-{{ p1_display_name }}-p3-display">{{ team1_p3_sog }}</td>
                                                        <td id="sog-{{ game.id }}-{{ p1_display_name }}-p4-display">{{ team1_p4_sog }}</td>
                                                        <td id="sog-{{ game.id }}-{{ p1_display_name }}-total-display"><strong>{{ team1_total_sog }}</strong></td>
                                                    </tr>
                                                    {# Team 2 SOG Display #}
                                                    {% set team2_sog = game.sog_data.get(p2_display_name, {}) %}
                                                    {% set team2_p1_sog = team2_sog.get(1, 0) %}
                                                    {% set team2_p2_sog = team2_sog.get(2, 0) %}
                                                    {% set team2_p3_sog = team2_sog.get(3, 0) %}
                                                    {% set team2_p4_sog = team2_sog.get(4, 0) %}
                                                    {% set team2_total_sog = team2_p1_sog + team2_p2_sog + team2_p3_sog + team2_p4_sog %}
                                                    <tr>
                                                        <td>
                                                            {% set t2_iso = team_iso_codes.get(p2_display_name) %}
                                                            {% if t2_iso %}<img src="https://flagcdn.com/w20/{{ t2_iso }}.png" alt="" style="margin-right: 3px;">{% endif %}
                                                            {{ p2_display_name }}
                                                        </td>
                                                        <td id="sog-{{ game.id }}-{{ p2_display_name }}-p1-display">{{ team2_p1_sog }}</td>
                                                        <td id="sog-{{ game.id }}-{{ p2_display_name }}-p2-display">{{ team2_p2_sog }}</td>
                                                        <td id="sog-{{ game.id }}-{{ p2_display_name }}-p3-display">{{ team2_p3_sog }}</td>
                                                        <td id="sog-{{ game.id }}-{{ p2_display_name }}-p4-display">{{ team2_p4_sog }}</td>
                                                        <td id="sog-{{ game.id }}-{{ p2_display_name }}-total-display"><strong>{{ team2_total_sog }}</strong></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <p class="text-muted"><small>SOG-Eingabe ist für Spiele mit noch nicht aufgelösten Platzhalter-Teams (z.B. A1 vs B2) nicht verfügbar. Bitte erst Spielergebnisse eintragen, die zur Auflösung führen.</small></p>
                                        {% endif %}
                                        {# --- END OF SHOTS ON GOAL (SOG) SECTION (Old form removed) --- #}

                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p>Keine Spiele in dieser Runde vorhanden.</p>
            {% endif %}
        </div>
        {% endfor %}

        {# Statistics Tab Content #}
        {% if top_scorers_points or top_goal_scorers or top_assist_providers or top_penalty_players %}
        <div class="tab-pane fade" id="statistics" role="tabpanel" aria-labelledby="statistics-tab">
            <div class="stats-section">
                <h2 class="stats-title">Player Stats</h2>

                {# Form for team filter - ensure stats_filter_teams and current_stats_team_filter are passed from app.py if this is kept #}
                {# For now, assuming unique_teams_in_year and selected_team are used #}
                <div class="filter-section">
                    <form method="GET" action="{{ url_for('year_bp.year_view', year_id=year.id) }}#statistics" class="mb-3">
                        <div class="form-row align-items-end">
                            <div class="col-md-4">
                                <label for="stats_team_filter">Team filtern:</label>
                                <select name="stats_team_filter" id="stats_team_filter" class="form-control form-control-sm">
                                    <option value="">Alle Teams</option> {# Added option for all teams #}
                                    {% for team_code_filter in unique_teams_in_year %} {# Changed to unique_teams_in_year #}
                                        <option value="{{ team_code_filter }}" {% if team_code_filter == selected_team %}selected{% endif %}>
                                            {{ team_code_filter }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                             <div class="col-md-2">
                                {% if selected_team %}
                                <a href="{{ url_for('year_bp.year_view', year_id=year.id, stats_team_filter='') }}#statistics" class="btn btn-sm btn-outline-secondary mt-auto">Filter löschen</a>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>

            <div class="row">
                {# Top Scorers (Points) #}
                <div class="col-md-12 mb-4 stats-section" id="top-scorers-points-section">
                    <h3>Top Scorer (Punkte) {% if selected_team %} ({{ selected_team }}) {% endif %}</h3>
                    {% if top_scorers_points %}
                    <table class="table table-sm table-striped">
                        <thead class="thead-light">
                            <tr>
                                <th>#</th>
                                <th>Spieler</th>
                                <th>Team</th>
                                <th title="Tore">T</th>
                                <th title="Assists">A</th>
                                <th title="Punkte">Pkt</th>
                            </tr>
                        </thead>
                        <tbody id="top-scorers-points-body">
                            {% for stat_entry in top_scorers_points %}
                            <tr {% if loop.index > 20 %}class="extra-stats-row d-none"{% endif %}>
                                <td>{{ loop.index }}</td>
                                <td>{{ stat_entry.player_obj.last_name.upper() }} {{ stat_entry.player_obj.first_name }}</td>
                                <td>
                                    {% set team_iso = team_iso_codes.get(stat_entry.player_obj.team_code) %}
                                    {% if team_iso %}<img src="https://flagcdn.com/w20/{{ team_iso }}.png" alt="{{ stat_entry.player_obj.team_code }}" style="margin-right: 5px;">{% endif %}
                                    {{ stat_entry.player_obj.team_code }}
                                </td>
                                <td>{{ stat_entry.goals }}</td>
                                <td>{{ stat_entry.assists }}</td>
                                <td><strong>{{ stat_entry.points }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% if top_scorers_points|length > 20 %}
                    <button class="btn btn-sm btn-outline-secondary toggle-stats-visibility" data-target-body="#top-scorers-points-body">Alle anzeigen</button>
                    {% endif %}
                    {% else %}
                    <p>Keine Scorer-Daten (Punkte) vorhanden{% if selected_team %} für {{ selected_team }}{% endif %}.</p>
                    {% endif %}
                </div>
            </div>

            <div class="row">
                {# Top Goal Scorers (Tore) - side by side with Assists #}
                <div class="col-lg-6 mb-4 stats-section" id="top-goal-scorers-section">
                    <h3>Top Torschützen (Tore) {% if selected_team %} ({{ selected_team }}) {% endif %}</h3>
                    {% if top_goal_scorers %}
                    <table class="table table-sm table-striped">
                        <thead class="thead-light">
                            <tr>
                                <th>#</th>
                                <th>Spieler</th>
                                <th>Team</th>
                                <th title="Tore">T</th>
                            </tr>
                        </thead>
                        <tbody id="top-goal-scorers-body">
                            {% for stat_entry in top_goal_scorers %}
                            <tr {% if loop.index > 20 %}class="extra-stats-row d-none"{% endif %}>
                                <td>{{ loop.index }}</td>
                                <td>{{ stat_entry.player_obj.last_name.upper() }} {{ stat_entry.player_obj.first_name }}</td>
                                <td>
                                    {% set team_iso = team_iso_codes.get(stat_entry.player_obj.team_code) %}
                                    {% if team_iso %}<img src="https://flagcdn.com/w20/{{ team_iso }}.png" alt="{{ stat_entry.player_obj.team_code }}" style="margin-right: 5px;">{% endif %}
                                    {{ stat_entry.player_obj.team_code }}
                                </td>
                                <td><strong>{{ stat_entry.goals }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% if top_goal_scorers|length > 20 %}
                    <button class="btn btn-sm btn-outline-secondary toggle-stats-visibility" data-target-body="#top-goal-scorers-body">Alle anzeigen</button>
                    {% endif %}
                    {% else %}
                    <p>Keine Torschützen-Daten vorhanden{% if selected_team %} für {{ selected_team }}{% endif %}.</p>
                    {% endif %}
                </div>

                {# Top Assist Providers (Assists) - side by side with Goals #}
                <div class="col-lg-6 mb-4 stats-section" id="top-assist-providers-section">
                    <h3>Top Assistgeber (Assists) {% if selected_team %} ({{ selected_team }}) {% endif %}</h3>
                    {% if top_assist_providers %}
                    <table class="table table-sm table-striped">
                        <thead class="thead-light">
                            <tr>
                                <th>#</th>
                                <th>Spieler</th>
                                <th>Team</th>
                                <th title="Assists">A</th>
                            </tr>
                        </thead>
                        <tbody id="top-assist-providers-body">
                            {% for stat_entry in top_assist_providers %}
                            <tr {% if loop.index > 20 %}class="extra-stats-row d-none"{% endif %}>
                                <td>{{ loop.index }}</td>
                                <td>{{ stat_entry.player_obj.last_name.upper() }} {{ stat_entry.player_obj.first_name }}</td>
                                <td>
                                    {% set team_iso = team_iso_codes.get(stat_entry.player_obj.team_code) %}
                                    {% if team_iso %}<img src="https://flagcdn.com/w20/{{ team_iso }}.png" alt="{{ stat_entry.player_obj.team_code }}" style="margin-right: 5px;">{% endif %}
                                    {{ stat_entry.player_obj.team_code }}
                                </td>
                                <td><strong>{{ stat_entry.assists }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% if top_assist_providers|length > 20 %}
                    <button class="btn btn-sm btn-outline-secondary toggle-stats-visibility" data-target-body="#top-assist-providers-body">Alle anzeigen</button>
                    {% endif %}
                    {% else %}
                    <p>Keine Assist-Daten vorhanden{% if selected_team %} für {{ selected_team }}{% endif %}.</p>
                    {% endif %}
                </div>
            </div>

            <div class="row">

                {# Most Penalty Minutes (PIM) #}
                <div class="col-md-12 mb-4 stats-section" id="top-penalty-players-section">
                    <h3>Meiste Strafminuten (PIM) {% if selected_team %} ({{ selected_team }}) {% endif %}</h3>
                    {% if top_penalty_players %}
                    <table class="table table-sm table-striped">
                        <thead class="thead-light">
                            <tr>
                                <th>#</th>
                                <th>Spieler</th>
                                <th>Team</th>
                                <th title="Strafminuten">PIM</th>
                            </tr>
                        </thead>
                        <tbody id="top-penalty-players-body">
                            {% for stat_entry in top_penalty_players %}
                            <tr {% if loop.index > 20 %}class="extra-stats-row d-none"{% endif %}>
                                <td>{{ loop.index }}</td>
                                <td>{{ stat_entry.player_obj.last_name.upper() }} {{ stat_entry.player_obj.first_name }}</td>
                                <td>
                                    {% set team_iso = team_iso_codes.get(stat_entry.player_obj.team_code) %}
                                    {% if team_iso %}<img src="https://flagcdn.com/w20/{{ team_iso }}.png" alt="{{ stat_entry.player_obj.team_code }}" style="margin-right: 5px;">{% endif %}
                                    {{ stat_entry.player_obj.team_code }}
                                </td>
                                <td><strong>{{ stat_entry.pim }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% if top_penalty_players|length > 20 %}
                    <button class="btn btn-sm btn-outline-secondary toggle-stats-visibility" data-target-body="#top-penalty-players-body">Alle anzeigen</button>
                    {% endif %}
                    {% else %}
                    <p>Keine Strafminuten-Daten vorhanden{% if selected_team %} für {{ selected_team }}{% endif %}.</p>
                    {% endif %}
                </div>
            </div>
            </div>
        </div>
        {% endif %}

        {# Team Stats Tab Content #}
        {% if team_stats_data %} {# Assumed variable from backend #}
        <div class="tab-pane fade" id="team-stats" role="tabpanel" aria-labelledby="team-stats-tab-link">
            <div class="stats-section">
                <h2 class="stats-title">Team Statistiken</h2>
            <div class="table-responsive">
                <table class="table table-sm table-striped table-hover" id="team-stats-table">
                    <thead class="thead-light">
                        <tr>
                            <th>Team</th> {# Not sortable #}
                            <th data-sort="gp" class="sortable-header text-center">GP <i class="fas fa-sort"></i></th>
                            <th data-sort="gf" class="sortable-header text-center">GF <i class="fas fa-sort"></i></th>
                            <th data-sort="ga" class="sortable-header text-center">GA <i class="fas fa-sort"></i></th>
                            <th data-sort="eng" class="sortable-header text-center" title="Empty Net Goals">ENG <i class="fas fa-sort"></i></th>
                            <th data-sort="sog" class="sortable-header text-center" title="Shots On Goal">SOG <i class="fas fa-sort"></i></th>
                            <th data-sort="soga" class="sortable-header text-center" title="Shots On Goal Against">SOGA <i class="fas fa-sort"></i></th>
                            <th data-sort="so" class="sortable-header text-center" title="Shutouts">SO <i class="fas fa-sort"></i></th>
                            <th data-sort="ppgf" class="sortable-header text-center" title="Powerplay Goals For">PPGF <i class="fas fa-sort"></i></th>
                            <th data-sort="ppga" class="sortable-header text-center" title="Powerplay Goals Against">PPGA <i class="fas fa-sort"></i></th>
                            <th data-sort="ppf" class="sortable-header text-center" title="Powerplay Opportunities For">PPF <i class="fas fa-sort"></i></th>
                            <th data-sort="ppa" class="sortable-header text-center" title="Powerplay Opportunities Against (Times Shorthanded)">PPA <i class="fas fa-sort"></i></th>
                            <th data-sort="pim" class="sortable-header text-center" title="Penalty Infraction Minutes">PIM <i class="fas fa-sort"></i></th>
                        </tr>
                    </thead>
                    <tbody id="team-stats-tbody">
                        {% for team_stat_entry in team_stats_data %}
                        {% if team_stat_entry.gp > 0 %} {# <-- ADDED THIS CONDITION #}
                        <tr>
                            <td>
                                {% if team_stat_entry.team_iso_code %}<img src="https://flagcdn.com/w20/{{ team_stat_entry.team_iso_code }}.png" alt="{{ team_stat_entry.team_name }}" style="margin-right: 5px; vertical-align: middle;">{% endif %}
                                {{ team_stat_entry.team_name }}
                            </td>
                            <td class="text-center">{{ team_stat_entry.gp }}</td>
                            <td class="text-center">{{ team_stat_entry.gf }}</td>
                            <td class="text-center">{{ team_stat_entry.ga }}</td>
                            <td class="text-center">{{ team_stat_entry.eng }}</td>
                            <td class="text-center">{{ team_stat_entry.sog }}</td>
                            <td class="text-center">{{ team_stat_entry.soga }}</td>
                            <td class="text-center">{{ team_stat_entry.so }}</td>
                            <td class="text-center">{{ team_stat_entry.ppgf }}</td>
                            <td class="text-center">{{ team_stat_entry.ppga }}</td>
                            <td class="text-center">{{ team_stat_entry.ppf }}</td>
                            <td class="text-center">{{ team_stat_entry.ppa }}</td>
                            <td class="text-center">{{ team_stat_entry.pim }}</td>
                        </tr>
                        {% endif %} {# <-- ADDED THIS ENDIF #}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if not team_stats_data %} {# Fallback message if team_stats_data is present but empty for some reason #}
                 <p>Keine Team-Statistiken für dieses Jahr verfügbar.</p>
            {% endif %}

            {# New Row for Small Stats Tables #}
            {% if team_stats_data %} {# Only show if there's data #}
            <div class="row mt-4">
                {# Scoring Efficiency Table #}
                <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
                    <h5>Scoring Efficiency</h5>
                    <table class="table table-sm table-striped" id="scoring-eff-table">
                        <thead class="thead-light">
                            <tr>
                                <th style="width: 50%;">Team</th>
                                <th data-sort="gf_eff" class="sortable-header text-center" title="Goals For">GF <i class="fas fa-sort"></i></th>
                                <th data-sort="sog_eff" class="sortable-header text-center" title="Shots On Goal">SOG <i class="fas fa-sort"></i></th>
                                <th data-sort="sg_perc" class="sortable-header text-center" title="Shooting Percentage">SG% <i class="fas fa-sort"></i></th>
                            </tr>
                        </thead>
                        <tbody id="scoring-eff-tbody">
                            {% for team in team_stats_data %}
                            {% if team.gp > 0 %} {# <-- ADDED THIS CONDITION #}
                            <tr>
                                <td>
                                    {% if team.team_iso_code %}<img src="https://flagcdn.com/w20/{{ team.team_iso_code }}.png" alt="{{ team.team_name }}" style="margin-right: 3px; vertical-align: middle;">{% endif %}
                                    {{ team.team_name }}
                                </td>
                                <td class="text-center">{{ team.gf }}</td>
                                <td class="text-center">{{ team.sog }}</td>
                                <td class="text-center">
                                    {% if team.sog > 0 %}{{ "%.1f"|format(team.gf * 100 / team.sog) }}%{% else %}0.0%{% endif %}
                                </td>
                            </tr>
                            {% endif %} {# <-- ADDED THIS ENDIF #}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                {# Goalkeeping Table #}
                <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
                    <h5>Goalkeeping</h5>
                    <table class="table table-sm table-striped" id="goalkeeping-table">
                        <thead class="thead-light">
                            <tr>
                                <th style="width: 50%;">Team</th>
                                <th data-sort="ga_gk" class="sortable-header text-center" title="Goals Against">GA <i class="fas fa-sort"></i></th>
                                <th data-sort="soga_gk" class="sortable-header text-center" title="Shots On Goal Against">SOGA <i class="fas fa-sort"></i></th>
                                <th data-sort="svs_perc" class="sortable-header text-center" title="Save Percentage">SVS% <i class="fas fa-sort"></i></th>
                            </tr>
                        </thead>
                        <tbody id="goalkeeping-tbody">
                            {% for team in team_stats_data %}
                            {% if team.gp > 0 %} {# <-- ADDED THIS CONDITION #}
                            <tr>
                                <td>
                                    {% if team.team_iso_code %}<img src="https://flagcdn.com/w20/{{ team.team_iso_code }}.png" alt="{{ team.team_name }}" style="margin-right: 3px; vertical-align: middle;">{% endif %}
                                    {{ team.team_name }}
                                </td>
                                <td class="text-center">{{ team.ga }}</td>
                                <td class="text-center">{{ team.soga }}</td>
                                <td class="text-center">
                                    {% if team.soga > 0 %}{{ "%.1f"|format((team.soga - team.ga) * 100 / team.soga) }}%{% else %}0.0%{% endif %}
                                </td>
                            </tr>
                            {% endif %} {# <-- ADDED THIS ENDIF #}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                {# Powerplay Table #}
                <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
                    <h5>Powerplay</h5>
                    <table class="table table-sm table-striped" id="powerplay-table">
                        <thead class="thead-light">
                            <tr>
                                <th style="width: 50%;">Team</th>
                                <th data-sort="ppgf_pp" class="sortable-header text-center" title="Powerplay Goals For">PPGF <i class="fas fa-sort"></i></th>
                                <th data-sort="ppf_pp" class="sortable-header text-center" title="Powerplay Opportunities For">PPF <i class="fas fa-sort"></i></th>
                                <th data-sort="pp_perc" class="sortable-header text-center" title="Powerplay Percentage">PP% <i class="fas fa-sort"></i></th>
                            </tr>
                        </thead>
                        <tbody id="powerplay-tbody">
                            {% for team in team_stats_data %}
                            {% if team.gp > 0 %} {# <-- ADDED THIS CONDITION #}
                            <tr>
                                <td>
                                    {% if team.team_iso_code %}<img src="https://flagcdn.com/w20/{{ team.team_iso_code }}.png" alt="{{ team.team_name }}" style="margin-right: 3px; vertical-align: middle;">{% endif %}
                                    {{ team.team_name }}
                                </td>
                                <td class="text-center">{{ team.ppgf }}</td>
                                <td class="text-center">{{ team.ppf }}</td>
                                <td class="text-center">
                                    {% if team.ppf > 0 %}{{ "%.1f"|format(team.ppgf * 100 / team.ppf) }}%{% else %}0.0%{% endif %}
                                </td>
                            </tr>
                            {% endif %} {# <-- ADDED THIS ENDIF #}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                {# Penalty Killing Table #}
                <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
                    <h5>Penalty Killing</h5>
                    <table class="table table-sm table-striped" id="penalty-kill-table">
                        <thead class="thead-light">
                            <tr>
                                <th style="width: 50%;">Team</th>
                                <th data-sort="ppga_pk" class="sortable-header text-center" title="Powerplay Goals Against">PPGA <i class="fas fa-sort"></i></th>
                                <th data-sort="ppa_pk" class="sortable-header text-center" title="Times Shorthanded">PPA <i class="fas fa-sort"></i></th>
                                <th data-sort="pk_perc" class="sortable-header text-center" title="Penalty Kill Percentage">PK% <i class="fas fa-sort"></i></th>
                            </tr>
                        </thead>
                        <tbody id="penalty-kill-tbody">
                            {% for team in team_stats_data %}
                            {% if team.gp > 0 %} {# <-- ADDED THIS CONDITION #}
                            <tr>
                                <td>
                                    {% if team.team_iso_code %}<img src="https://flagcdn.com/w20/{{ team.team_iso_code }}.png" alt="{{ team.team_name }}" style="margin-right: 3px; vertical-align: middle;">{% endif %}
                                    {{ team.team_name }}
                                </td>
                                <td class="text-center">{{ team.ppga }}</td>
                                <td class="text-center">{{ team.ppa }}</td>
                                <td class="text-center">
                                    {% if team.ppa == 0 %}100.0%
                                    {% else %}{{ "%.1f"|format((team.ppa - team.ppga) * 100 / team.ppa) }}%
                                    {% endif %}
                                </td>
                            </tr>
                            {% endif %} {# <-- ADDED THIS ENDIF #}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %} {# End of if team_stats_data for small tables #}
            </div>
        </div>
        {% endif %} {# End of Team Stats Tab Content #}

    </div>
{% endif %}

{# Overrule Modal #}
<div class="modal fade" id="overruleModal" tabindex="-1" role="dialog" aria-labelledby="overruleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="overruleModalLabel">Score-Matching Überregeln</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Schließen">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="overruleModalGameInfo" class="mb-3">
                    <strong>Spiel:</strong> <span id="overruleGameDescription"></span>
                </div>
                <div id="overruleModalWarnings" class="mb-3">
                    <h6>Aktuelle Probleme:</h6>
                    <ul id="overruleWarningsList" class="text-danger">
                        <!-- Warnings will be populated by JavaScript -->
                    </ul>
                </div>
                <form id="overruleForm">
                    <div class="form-group">
                        <label for="overruleReason">Grund für die Überregelung:</label>
                        <textarea class="form-control" id="overruleReason" name="reason" rows="4" 
                                  placeholder="Bitte geben Sie an, warum die Score-Matching-Regeln für dieses Spiel nicht gelten (z.B. 'Penalty-Shoot-Out Tor nicht als reguläres Tor erfasst', 'SOG-Daten bewusst nicht erfasst', etc.)" required></textarea>
                    </div>
                    <div id="existingOverruleInfo" class="alert alert-info d-none">
                        <strong>Bestehende Überregelung:</strong>
                        <div id="existingOverruleReason"></div>
                        <small class="text-muted">Erstellt: <span id="existingOverruleDate"></span></small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-danger" id="removeOverruleBtn" style="display: none;">Überregelung entfernen</button>
                <button type="button" class="btn btn-warning" id="saveOverruleBtn">Überregelung speichern</button>
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <a href="{{ url_for('main_bp.index') }}" class="btn btn-secondary">&laquo; Zurück zur Jahresübersicht</a>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
$(document).ready(function(){
    // Initialize tooltips - Disable Bootstrap tooltips and use native browser tooltips
    // Convert data-toggle="tooltip" to native title attributes
    $('[data-toggle="tooltip"]').each(function() {
        var $this = $(this);
        var tooltipText = $this.attr('title') || $this.attr('data-original-title');
        if (tooltipText) {
            $this.attr('title', tooltipText);
            $this.removeAttr('data-toggle');
            $this.removeAttr('data-original-title');
        }
    });

    // SOG Form Submission Handler using jQuery event delegation
    $(document).on('submit', 'form[id^="sogEditForm-"]', function(event) { // Changed ID to sogEditForm-
        event.preventDefault(); // Prevent default form submission
        var gameId = this.id.split('-')[1]; // Extract gameId from form id (e.g., "sogEditForm-123")
        handleSogSubmit(gameId); 
    });

    // Validate SOG when OT shots or result type changes
    $(document).on('change blur', 'input[name="team1_p4_shots"], input[name="team2_p4_shots"]', function() {
        const gameId = $(this).closest('form').attr('id').split('-')[1];
        validateAndShowSogWarning(gameId);
    });

    $(document).on('change', 'select[name="result_type"]', function() {
        const gameId = $(this).closest('tr').attr('id').replace('game-', '');
        if (gameId) {
            validateAndShowSogWarning(gameId);
        }
    });

    // Re-validate SOG after game score/result_type form submission (page reload)
    $(document).ready(function() {
        // Check all games on page load to ensure SOG overtime validation is applied
        $('tr[id^="game-"]').each(function() {
            const gameId = $(this).attr('id').replace('game-', '');
            if (gameId) {
                // Small delay to ensure all elements are loaded
                setTimeout(function() {
                    validateAndShowSogWarning(gameId);
                }, 100);
            }
        });
    });

    function validateAndShowSogWarning(gameId) {
        const validationResult = validateSogForOvertimeGame(gameId);
        const messageArea = $('#sogMessageArea-' + gameId);
        
        if (!validationResult.valid) {
            // Only show warning if there's no other alert already showing
            if (messageArea.find('.alert').length === 0) {
                messageArea.html('<div class="alert alert-warning alert-dismissible fade show" role="alert">' + 
                               '<i class="fas fa-exclamation-triangle"></i> ' + validationResult.message + 
                               '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
            }
        } else {
            // Clear warning if validation passes
            messageArea.find('.alert-warning').alert('close');
        }
        
        // Update score match indicator when SOG validation changes
        // Check current indicator state to preserve existing validation results
        const indicatorContainer = $('#scoreMatchIndicatorContainer-' + gameId);
        const currentIndicator = indicatorContainer.find('.score-match-indicator');
        
        // Don't update if overruled
        if (currentIndicator.hasClass('overruled-indicator')) {
            return;
        }
        
        let currentScoresMatch = true; // Default assumption for cases where we can't determine
        
        if (currentIndicator.hasClass('valid-indicator')) {
            currentScoresMatch = true;
        } else if (currentIndicator.hasClass('invalid-indicator')) {
            // Check if the current error is only about SOG overtime or also other issues
            const currentTitle = currentIndicator.attr('title') || '';
            currentScoresMatch = !currentTitle.includes('Spielstand und erfasste Tore stimmen NICHT überein');
        } else {
            // No indicator present - need to determine from backend data
            // Look at the original server-rendered state
            const gameRow = $('#game-' + gameId);
            const scoreMatchSpan = gameRow.find('span[data-game-id="' + gameId + '"]');
            if (scoreMatchSpan.length > 0) {
                // Use the original server state as reference
                currentScoresMatch = scoreMatchSpan.hasClass('valid-indicator') || 
                                   !scoreMatchSpan.attr('title')?.includes('Spielstand und erfasste Tore stimmen NICHT überein');
            }
        }
        
        updateScoreMatchIndicatorSafe(gameId, currentScoresMatch);
    }

    // Helper function to update score match indicator while respecting overrules
    function updateScoreMatchIndicatorSafe(gameId, scoresMatch) {
        var indicatorContainer = $('#scoreMatchIndicatorContainer-' + gameId);
        var gameRow = $('#game-' + gameId);
        var scoreInput1 = gameRow.find('input[name="team1_score"]');
        var scoreInput2 = gameRow.find('input[name="team2_score"]');
        var team1ScoreIsSet = scoreInput1.val() !== '' && scoreInput1.val() !== null;
        var team2ScoreIsSet = scoreInput2.val() !== '' && scoreInput2.val() !== null;

        if (team1ScoreIsSet || team2ScoreIsSet) {
            // Check if there's an existing overrule - if so, don't change the indicator
            var existingOverrule = indicatorContainer.find('.overruled-indicator');
            if (existingOverrule.length === 0) {
                // Check SOG overtime validation
                var sogOvertimeValidation = validateSogForOvertimeGame(gameId);
                var allValidationsPass = scoresMatch && sogOvertimeValidation.valid;
                
                if (allValidationsPass) {
                    indicatorContainer.html('<span class="text-success score-match-indicator valid-indicator" data-game-id="' + gameId + '" title="Spielstand, erfasste Tore, SOG-Daten und Powerplay-Situationen sind vollständig und korrekt. Overtime-Regeln und Penalty-Sonderregeln (5+Spieldauer, 2+2 Min) beachtet.">✓</span>');
                } else {
                    var errorMessages = [];
                    if (!scoresMatch) {
                        errorMessages.push("Spielstand und erfasste Tore stimmen NICHT überein, SOG-Daten fehlen für P1-P3, Overtime-Regeln verletzt (Tore nach 60:00 erfordern n.V. und Tordifferenz von 1), oder Powerplay-/Penalty-Situationen sind inkonsistent (PP/SH-Tore bei aktiven Strafen, Sonderregeln für 5+Spieldauer und 2+2 Min beachtet)");
                    }
                    if (!sogOvertimeValidation.valid) {
                        errorMessages.push(sogOvertimeValidation.message);
                    }
                    var tooltipText = errorMessages.join(". ") + ". Klicken zum Überregeln.";
                    
                    indicatorContainer.html('<span class="text-danger score-match-indicator invalid-indicator" data-game-id="' + gameId + '" style="cursor: pointer;" title="' + tooltipText + '">✗</span>');
                }
            }
        } else { 
            indicatorContainer.empty(); 
        }
    }

    function convertTimeToSeconds(timeStr) {
        if (!timeStr || timeStr.indexOf(':') === -1) return Infinity;
        try {
            const parts = timeStr.split(':');
            const minutes = parseInt(parts[0], 10);
            const seconds = parseInt(parts[1], 10);
            if (isNaN(minutes) || isNaN(seconds)) return Infinity;
            return minutes * 60 + seconds;
        } catch (e) {
            return Infinity;
        }
    }

    function insertEventIntoSortedList(gameId, newEventHtml, eventTimeStr) {
        const newEventTimeInSeconds = convertTimeToSeconds(eventTimeStr);
        const gameEventsList = $('#gameEventsDisplayArea-' + gameId + ' ul.list-group');
        let inserted = false;

        if (gameEventsList.length === 0) { // If UL doesn't exist, create it and add the item
            $('#gameEventsDisplayArea-' + gameId).html('<ul class="list-group list-group-flush">' + newEventHtml + '</ul>');
            $('#noGameEventsMessage-' + gameId).addClass('d-none');
            return;
        }

        gameEventsList.children('li.event-item').each(function() { // Add class event-item to actual events
            const existingEventTimeStr = $(this).find('h6.event-time').text(); // Add class event-time to h6
            const existingEventTimeInSeconds = convertTimeToSeconds(existingEventTimeStr);
            if (newEventTimeInSeconds < existingEventTimeInSeconds) {
                $(this).before(newEventHtml);
                inserted = true;
                return false; // Break jQuery .each loop
            }
        });

        if (!inserted) {
            gameEventsList.append(newEventHtml);
        }
        $('#noGameEventsMessage-' + gameId).addClass('d-none');
    }

    // Handle tab and collapse state based on URL hash
    var hash = window.location.hash;
    if (hash) {
        // Adjusted to target the new #game-details-GAME_ID for goal/penalty related anchors
        if (hash.startsWith("#goal-entry-") || hash.startsWith("#penalty-entry-") || hash.startsWith("#game-details-")) {
            var gameIdForAnchor = hash.substring(hash.lastIndexOf('-') + 1);
            if (gameIdForAnchor.endsWith('/')) { // Clean up if anchor somehow has trailing slash (less likely now)
                gameIdForAnchor = gameIdForAnchor.slice(0, -1);
            }
            var detailsCollapse = $('#game-details-' + gameIdForAnchor);
            
            if (detailsCollapse.length) {
                detailsCollapse.collapse('show');
                var gameRow = $('#game-' + gameIdForAnchor); // The TR of the game itself for scrolling
                if (gameRow.length > 0) {
                    var tabPane = gameRow.closest('.tab-pane');
                    if (tabPane.length > 0) {
                        var tabId = tabPane.attr('id');
                        $('.nav-tabs a[href="#' + tabId + '"]').tab('show');
                        // Scroll to the game row, not the forms inside, as the section is now expanded.
                        $('html, body').animate({
                            scrollTop: gameRow.offset().top - 100 
                        }, 500);
                    }
                }
            }
        } else if (hash.startsWith("#game-")) {
            var gameRowToScroll = $(hash);
            if (gameRowToScroll.length > 0) {
                var tabPane = gameRowToScroll.closest('.tab-pane');
                if (tabPane.length > 0) {
                    var tabId = tabPane.attr('id');
                    $('.nav-tabs a[href="#' + tabId + '"]').tab('show');
                }
                 $('html, body').animate({
                    scrollTop: gameRowToScroll.offset().top - 100
                }, 500);
            }
        } else if ($('.nav-tabs a[href="' + hash + '"]').length) {
            $('.nav-tabs a[href="' + hash + '"]').tab('show');
        }
    }

    // Enhanced time input handler for goals and penalties
    function parseTimeInput(inputValue) {
        if (!inputValue) return { valid: false, error: 'Keine Zeit eingegeben' };
        
        var value = inputValue.trim();
        
        // Handle numeric input with any non-digit separator or pure numbers
        // Examples: 1234 → 12:34, 754 → 7:54, 123 → 1:23, 12x34 → 12:34, 12;34 → 12:34
        if (/^\d+$/.test(value) || /^\d+[^\d]\d+$/.test(value)) {
            var digits = value.replace(/[^\d]/g, ''); // Remove all non-digits
            
            if (digits.length < 3 || digits.length > 4) {
                return { valid: false, error: 'Zeitformat muss 3-4 Ziffern haben (z.B. 123 → 1:23, 1234 → 12:34)' };
            }
            
            var minutes, seconds;
            if (digits.length === 3) {
                // 123 → 1:23
                minutes = parseInt(digits.substring(0, 1));
                seconds = parseInt(digits.substring(1, 3));
            } else {
                // 1234 → 12:34
                minutes = parseInt(digits.substring(0, 2));
                seconds = parseInt(digits.substring(2, 4));
            }
            
            if (seconds >= 60) {
                return { valid: false, error: 'Sekunden müssen < 60 sein' };
            }
            
            var formattedTime = (minutes < 10 ? '0' + minutes : minutes) + ':' + (seconds < 10 ? '0' + seconds : seconds);
            return { valid: true, time: formattedTime };
        }
        
        // Standard mm:ss format (0:00-99:59)
        if (/^\d{1,2}:\d{2}$/.test(value)) {
            var parts = value.split(':');
            var minutes = parseInt(parts[0]);
            var seconds = parseInt(parts[1]);
            
            if (seconds >= 60) {
                return { valid: false, error: 'Sekunden müssen < 60 sein' };
            }
            
            // Add leading zero if needed
            var formattedTime = (minutes < 10 ? '0' + minutes : minutes) + ':' + (seconds < 10 ? '0' + seconds : seconds);
            return { valid: true, time: formattedTime };
        }
        
        // Period time - remaining (e.g., "1-5:13" = 1st period, 5:13 remaining)
        if (/^[1-3]-\d{1,2}:\d{2}$/.test(value)) {
            var match = value.match(/^([1-3])-(\d{1,2}):(\d{2})$/);
            var period = parseInt(match[1]);
            var remainingMin = parseInt(match[2]);
            var remainingSec = parseInt(match[3]);
            
            if (remainingSec >= 60) {
                return { valid: false, error: 'Sekunden müssen < 60 sein' };
            }
            if (remainingMin >= 20) {
                return { valid: false, error: 'Verbleibende Zeit kann nicht >= 20 Min sein' };
            }
            
            // Calculate elapsed time in period
            var totalRemainingSeconds = remainingMin * 60 + remainingSec;
            var periodSeconds = 20 * 60; // 20 minutes per period
            var elapsedInPeriod = periodSeconds - totalRemainingSeconds;
            
            // Add time from previous periods
            var totalElapsed = (period - 1) * periodSeconds + elapsedInPeriod;
            var finalMin = Math.floor(totalElapsed / 60);
            var finalSec = totalElapsed % 60;
            
            var formattedTime = (finalMin < 10 ? '0' + finalMin : finalMin) + ':' + (finalSec < 10 ? '0' + finalSec : finalSec);
            return { valid: true, time: formattedTime };
        }
        
        // Period time - elapsed (e.g., "2+10:35" = 2nd period, 10:35 elapsed)
        if (/^[1-3]\+\d{1,2}:\d{2}$/.test(value)) {
            var match = value.match(/^([1-3])\+(\d{1,2}):(\d{2})$/);
            var period = parseInt(match[1]);
            var elapsedMin = parseInt(match[2]);
            var elapsedSec = parseInt(match[3]);
            
            if (elapsedSec >= 60) {
                return { valid: false, error: 'Sekunden müssen < 60 sein' };
            }
            if (elapsedMin >= 20) {
                return { valid: false, error: 'Verstrichene Zeit kann nicht >= 20 Min sein' };
            }
            
            // Calculate total elapsed time
            var periodSeconds = 20 * 60; // 20 minutes per period
            var elapsedInPeriod = elapsedMin * 60 + elapsedSec;
            var totalElapsed = (period - 1) * periodSeconds + elapsedInPeriod;
            
            var finalMin = Math.floor(totalElapsed / 60);
            var finalSec = totalElapsed % 60;
            
            var formattedTime = (finalMin < 10 ? '0' + finalMin : finalMin) + ':' + (finalSec < 10 ? '0' + finalSec : finalSec);
            return { valid: true, time: formattedTime };
        }
        
        // Overtime - remaining (e.g., "O5-1:23" = 5min OT, 1:23 remaining)
        if (/^O\d{1,2}-\d{1,2}:\d{2}$/.test(value)) {
            var match = value.match(/^O(\d{1,2})-(\d{1,2}):(\d{2})$/);
            var otLength = parseInt(match[1]);
            var remainingMin = parseInt(match[2]);
            var remainingSec = parseInt(match[3]);
            
            if (remainingSec >= 60) {
                return { valid: false, error: 'Sekunden müssen < 60 sein' };
            }
            if (remainingMin >= otLength) {
                return { valid: false, error: 'Verbleibende Zeit kann nicht >= OT-Länge sein' };
            }
            
            var totalRemainingSeconds = remainingMin * 60 + remainingSec;
            var otSeconds = otLength * 60;
            var elapsedInOt = otSeconds - totalRemainingSeconds;
            
            // Add regulation time (60 minutes) + elapsed OT time
            var totalElapsed = 60 * 60 + elapsedInOt;
            var finalMin = Math.floor(totalElapsed / 60);
            var finalSec = totalElapsed % 60;
            
            var formattedTime = (finalMin < 10 ? '0' + finalMin : finalMin) + ':' + (finalSec < 10 ? '0' + finalSec : finalSec);
            return { valid: true, time: formattedTime };
        }
        
        // Overtime - elapsed (e.g., "O5+3:45" = 5min OT, 3:45 elapsed)
        if (/^O\d{1,2}\+\d{1,2}:\d{2}$/.test(value)) {
            var match = value.match(/^O(\d{1,2})\+(\d{1,2}):(\d{2})$/);
            var otLength = parseInt(match[1]);
            var elapsedMin = parseInt(match[2]);
            var elapsedSec = parseInt(match[3]);
            
            if (elapsedSec >= 60) {
                return { valid: false, error: 'Sekunden müssen < 60 sein' };
            }
            if (elapsedMin >= otLength) {
                return { valid: false, error: 'Verstrichene Zeit kann nicht >= OT-Länge sein' };
            }
            
            var elapsedInOt = elapsedMin * 60 + elapsedSec;
            
            // Add regulation time (60 minutes) + elapsed OT time
            var totalElapsed = 60 * 60 + elapsedInOt;
            var finalMin = Math.floor(totalElapsed / 60);
            var finalSec = totalElapsed % 60;
            
            var formattedTime = (finalMin < 10 ? '0' + finalMin : finalMin) + ':' + (finalSec < 10 ? '0' + finalSec : finalSec);
            return { valid: true, time: formattedTime };
        }
        
        return { valid: false, error: 'Ungültiges Zeitformat' };
    }

    // Auto-format and validate time input for goals
    $(document).on('blur', 'input[id^="goal_minute-"]', function() {
        var input = $(this);
        var value = input.val();
        
        if (!value) return;
        
        var result = parseTimeInput(value);
        if (result.valid) {
            input.val(result.time);
            input.removeClass('is-invalid');
            input.next('.invalid-feedback').remove();
        } else {
            input.addClass('is-invalid');
            input.next('.invalid-feedback').remove();
            input.after('<div class="invalid-feedback">' + result.error + '</div>');
        }
    });

    // Auto-format and validate time input for penalties
    $(document).on('blur', 'input[id^="penalty_minute-"]', function() {
        var input = $(this);
        var value = input.val();
        
        if (!value) return;
        
        var result = parseTimeInput(value);
        if (result.valid) {
            input.val(result.time);
            input.removeClass('is-invalid');
            input.next('.invalid-feedback').remove();
        } else {
            input.addClass('is-invalid');
            input.next('.invalid-feedback').remove();
            input.after('<div class="invalid-feedback">' + result.error + '</div>');
        }
    });

    // Statistics table toggle
    $('.toggle-stats-visibility').on('click', function() {
        var $button = $(this);
        var targetBodySelector = $button.data('target-body');
        var $tableBody = $(targetBodySelector);
        
        $tableBody.find('tr.extra-stats-row').toggleClass('d-none');

        if ($button.text() === 'Alle anzeigen') {
            $button.text('Weniger anzeigen');
        } else {
            $button.text('Alle anzeigen');
        }
    });

    // Original Player selection population logic for GOALS (3 dropdowns)
    function populatePlayers(teamSelectElement, scorerSelectId, assist1SelectId, assist2SelectId) {
        var selectedTeamCode = $(teamSelectElement).val();
        var players = window.all_players_by_team_json[selectedTeamCode] || [];
        
        players.sort((a, b) => {
            let lastNameComp = a.last_name.localeCompare(b.last_name);
            if (lastNameComp !== 0) return lastNameComp;
            return a.first_name.localeCompare(b.first_name);
        });

        var scorerSelect = $('#' + scorerSelectId);
        var assist1Select = $('#' + assist1SelectId);
        var assist2Select = $('#' + assist2SelectId);

        var currentScorerVal = scorerSelect.val();
        var currentAssist1Val = assist1Select.val();
        var currentAssist2Val = assist2Select.val();

        scorerSelect.empty().append('<option value="">Spieler wählen...</option>');
        assist1Select.empty().append('<option value="">Spieler wählen...</option>');
        assist2Select.empty().append('<option value="">Spieler wählen...</option>');

        players.forEach(function(player) {
            scorerSelect.append($('<option>', { value: player.id, text: player.full_name }));
            assist1Select.append($('<option>', { value: player.id, text: player.full_name }));
            assist2Select.append($('<option>', { value: player.id, text: player.full_name }));
        });
        
        if (players.find(p => p.id == parseInt(currentScorerVal))) scorerSelect.val(currentScorerVal); else scorerSelect.val("");
        if (players.find(p => p.id == parseInt(currentAssist1Val))) assist1Select.val(currentAssist1Val); else assist1Select.val("");
        if (players.find(p => p.id == parseInt(currentAssist2Val))) assist2Select.val(currentAssist2Val); else assist2Select.val("");
    }

    // Player selection population logic for PENALTIES (single dropdown with team penalty option)
    function populatePlayerForPenalty(teamSelectElement, playerSelectElementId, includeTeamPenaltyOption = true) {
        var selectedTeamCode = $(teamSelectElement).val();
        var players = window.all_players_by_team_json[selectedTeamCode] || [];
        
        players.sort((a, b) => {
            let lastNameComp = a.last_name.localeCompare(b.last_name);
            if (lastNameComp !== 0) return lastNameComp;
            return a.first_name.localeCompare(b.first_name);
        });

        var playerSelect = $('#' + playerSelectElementId);
        var currentPlayerVal = playerSelect.val();

        playerSelect.empty().append('<option value="">Spieler wählen...</option>');
        if (includeTeamPenaltyOption) {
            playerSelect.append('<option value="-1">Teamstrafe</option>');
        }

        players.forEach(function(player) {
            playerSelect.append($('<option>', { value: player.id, text: player.full_name }));
        });
        
        if (players.find(p => p.id == parseInt(currentPlayerVal))) playerSelect.val(currentPlayerVal);
        else if (includeTeamPenaltyOption && currentPlayerVal == "-1") playerSelect.val("-1");
        else playerSelect.val("");
    }

    // For Goal player dropdowns
    $(document).on('change', 'select.goal-team-select', function() {
        var gameId = $(this).closest('form').find('input[name="game_id"]').val();
        populatePlayers(this, 'scorer-' + gameId, 'assist1-' + gameId, 'assist2-' + gameId); 
    });

    // Initial population for goal player dropdowns
    $('form[id^="addGoalForm-"]').each(function() {
        var gameId = $(this).find('input[name="game_id"]').val();
        var teamSelect = $(this).find('#goal_team-' + gameId);
        if (teamSelect.length > 0 && teamSelect.val()) { // Check if teamSelect has a value
             populatePlayers(teamSelect[0], 'scorer-' + gameId, 'assist1-' + gameId, 'assist2-' + gameId);
        }
    });

    // For Penalty player dropdown
    $(document).on('change', 'select.penalty-team-select', function() {
        var gameId = $(this).closest('form').find('input[name="game_id"]').val();
        populatePlayerForPenalty(this, 'penalty_player-' + gameId, true);
    });

    // Initial population for penalty player dropdowns on page load
    $('form[id^="addPenaltyForm-"]').each(function() {
        var gameId = $(this).find('input[name="game_id"]').val();
        var teamSelect = $(this).find('#penalty_team-' + gameId);
        if (teamSelect.length > 0 && teamSelect.val()) { // Check if teamSelect has a value
             populatePlayerForPenalty(teamSelect[0], 'penalty_player-' + gameId, true);
        }
    });

    // AJAX for Add Player form
    $(document).on('submit', 'form[id^="addPlayerForm-"]', function(event) {
        event.preventDefault();
        var form = $(this);
        var gameId = form.find('input[name="game_id_anchor"]').val();
        var messageArea = $('#messageArea-' + gameId); // Message area for Add Player
        
        $.ajax({
            url: "{{ url_for('year_bp.add_player') }}", // Use global add player
            type: 'POST',
            data: form.serialize(), // Changed to use form.serialize()
            success: function(response) {
                var alertClass = response.success ? 'alert-success' : 'alert-danger';
                messageArea.html('<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
                                 response.message +
                                 '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>' +
                                 '</div>');
                if (response.success) {
                    form[0].reset();
                    var newPlayer = response.player;
                    if (!window.all_players_by_team_json[newPlayer.team_code]) {
                        window.all_players_by_team_json[newPlayer.team_code] = [];
                    }
                    // Update player in list or add if new - include jersey number
                    let playerEntry = window.all_players_by_team_json[newPlayer.team_code].find(p => p.id === newPlayer.id);
                    if (playerEntry) {
                        playerEntry.first_name = newPlayer.first_name;
                        playerEntry.last_name = newPlayer.last_name;
                        playerEntry.jersey_number = newPlayer.jersey_number; // Ensure jersey is updated
                        playerEntry.full_name = newPlayer.full_name;
                    } else {
                        window.all_players_by_team_json[newPlayer.team_code].push({
                            id: newPlayer.id, 
                            first_name: newPlayer.first_name, 
                            last_name: newPlayer.last_name, 
                            team_code: newPlayer.team_code, 
                            jersey_number: newPlayer.jersey_number, // Add jersey number here
                            full_name: newPlayer.full_name
                        });
                    }
                    // Trigger change on relevant team select dropdowns to repopulate player lists
                    var addGoalForm = $('#addGoalForm-' + gameId);
                    if (addGoalForm.length > 0) {
                        var teamSelectForGoal = addGoalForm.find('#goal_team-' + gameId);
                        if (teamSelectForGoal.length > 0 && teamSelectForGoal.val() == newPlayer.team_code) { // only update if relevant team
                            teamSelectForGoal.trigger('change');
                        }
                    }
                    var addPenaltyForm = $('#addPenaltyForm-' + gameId);
                    if (addPenaltyForm.length > 0) {
                        var teamSelectForPenalty = addPenaltyForm.find('#penalty_team-' + gameId);
                         if (teamSelectForPenalty.length > 0 && teamSelectForPenalty.val() == newPlayer.team_code) { // only update if relevant team
                            teamSelectForPenalty.trigger('change');
                        }
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('Error adding player:', error, xhr.responseText);
                var serverMessage = 'Fehler beim Hinzufügen des Spielers.';
                if (xhr.responseText) {
                    try {
                        var jsonResponse = JSON.parse(xhr.responseText);
                        if (jsonResponse && jsonResponse.message) {
                            serverMessage = jsonResponse.message;
                        } else {
                            serverMessage = 'Fehler: ' + (xhr.statusText || 'Unbekannter Fehler');
                        }
                    } catch (e) {
                        serverMessage = 'Antwort vom Server konnte nicht verarbeitet werden: ' + (xhr.statusText || 'Unbekannter Fehler');
                    }
                }
                messageArea.html('<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                                 serverMessage +
                                 '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>' +
                                 '</div>');
            }
        });
    });

    // AJAX for Add Goal form
    $(document).on('submit', 'form[id^="addGoalForm-"]', function(event) {
        event.preventDefault();
        var form = $(this);
        var gameId = form.find('input[name="game_id"]').val();
        var messageArea = $('#goalMessageArea-' + gameId);
        var addGoalUrl = form.attr('action');

        fetch(addGoalUrl, {
            method: 'POST',
            body: new FormData(form[0]),
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errData => { throw new Error(errData.message || `HTTP error! status: ${response.status}`); });
            }
            return response.json();
        })
        .then(data => {
            var alertClass = data.success ? 'alert-success' : 'alert-danger';
            messageArea.html('<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
                             data.message +
                             '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>' +
                             '</div>');

            if (data.success) {
                form[0].reset(); 
                $('#goal_team-' + gameId).trigger('change');

                var newGoal = data.goal;
                var gameEventsDisplayArea = $('#gameEventsDisplayArea-' + gameId + ' ul.list-group');
                var noEventsMessage = $('#noGameEventsMessage-' + gameId);

                var scorerName = newGoal.scorer; // Corrected: scorer is already the full name string
                var assist1Name = newGoal.assist1 || '-'; // Corrected
                var assist2Name = newGoal.assist2 || '-'; // Corrected
                var goalTypeDisplay = newGoal.goal_type_display; // Use goal_type_display from response
                // is_empty_net is a boolean in the response, handle it in the IIFE
                
                var teamDisplayName = newGoal.team_code; // Default to code
                // Logic to get display name from title (can be kept or removed if team_code is enough)
                var titleElement = form.closest('.card-body').find('h5:first');
                if (titleElement.length) {
                    var titleText = titleElement.text();
                    var teamsInTitle = titleText.substring(titleText.indexOf(':') + 1).split(' vs ');
                    var gameTeam1CodeInForm = $('#addGoalForm-' + gameId).find('#goal_team-' + gameId + ' option:first-child').val(); // Get from the specific form
                    if (newGoal.team_code === gameTeam1CodeInForm && teamsInTitle.length > 0) {
                        teamDisplayName = teamsInTitle[0].trim();
                    } else if (teamsInTitle.length > 1) {
                         var gameTeam2CodeInForm = $('#addGoalForm-' + gameId).find('#goal_team-' + gameId + ' option:nth-child(2)').val();
                         if (newGoal.team_code === gameTeam2CodeInForm) teamDisplayName = teamsInTitle[1].trim();
                    }
                }

                var deleteGoalFormAction = "{{ url_for('year_bp.delete_goal', year_id=0, goal_id=0) }}".replace('/0/goal/0/delete', '/' + current_year_id + '/goal/' + newGoal.id + '/delete');

                var newEventHtml = '<li class="list-group-item event-item">' +
                    '<div class="d-flex w-100 justify-content-between">' +
                        '<h6 class="mb-1 event-time">' +
                        '<i class="fas fa-hockey-puck text-danger mr-2"></i>' +
                        newGoal.minute + '</h6>' +
                        '<small>' +
                            '<form method="POST" action="' + deleteGoalFormAction + '" style="display: inline;">' +
                            '<input type="hidden" name="game_id_anchor" value="' + gameId + '">' +
                                '<button type="submit" class="btn btn-danger btn-xs" onclick="this.form.action += \'#game-details-'+gameId+'\'; return confirm(\\\'Sicher, dass du dieses Tor löschen willst?\\\');" title="Tor löschen">&times;</button>' +
                        '</form>' +
                        '</small>' +
                    '</div>' +
                    '<p class="mb-1">' +
                        '<strong>Tor! ' + teamDisplayName + '</strong>' +
                        (function() { 
                            let details = [];
                            if (newGoal.goal_type_display !== 'REG' && newGoal.goal_type_display) { // Use goal_type_display
                                details.push(newGoal.goal_type_display);
                            } else if (newGoal.goal_type_display == 'REG' && !newGoal.is_empty_net) {
                                details.push("EQ");
                            }
                            if (newGoal.is_empty_net) { // is_empty_net is a boolean
                                details.push("EN");
                            }
                            return details.length > 0 ? ' (' + details.join(', ') + ')' : '';
                        })() + '<br>' +
                        'Torschütze: ' + scorerName +
                        (newGoal.assist1 ? '<br>Assist 1: ' + assist1Name : '') +
                        (newGoal.assist2 ? '<br>Assist 2: ' + assist2Name : '') +
                    '</p>' +
                '</li>';

                insertEventIntoSortedList(gameId, newEventHtml, newGoal.minute);

                var currentEventCount = parseInt($('#eventCountBadge-' + gameId).text());
                $('#eventCountBadge-' + gameId).text(currentEventCount + 1);

                // Update score match indicator as before
                updateScoreMatchIndicatorSafe(gameId, data.scores_fully_match_goals);
            }
        })
        .catch(error => {
            console.error('Error adding goal:', error);
            messageArea.html('<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                             'Kommunikationsfehler: ' + error.message +
                             '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>' +
                             '</div>');
        });
    });

    // AJAX for Add Penalty form
    $(document).on('submit', 'form[id^="addPenaltyForm-"]', function(event) {
        event.preventDefault();
        var form = $(this);
        var gameId = form.find('input[name="game_id"]').val();
        var messageArea = $('#penaltyMessageArea-' + gameId);
        var addPenaltyUrl = form.attr('action');

        fetch(addPenaltyUrl, {
            method: 'POST',
            body: new FormData(form[0]),
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errData => { throw new Error(errData.message || `HTTP error! status: ${response.status}`); });
            }
            return response.json();
        })
        .then(data => {
            var alertClass = data.success ? 'alert-success' : 'alert-danger';
            messageArea.html('<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
                             data.message +
                             '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>' +
                             '</div>');

            if (data.success) {
                form[0].reset(); 
                $('#penalty_team-' + gameId).trigger('change');

                var newPenalty = data.penalty;
                var gameEventsDisplayArea = $('#gameEventsDisplayArea-' + gameId + ' ul.list-group');
                var noEventsMessage = $('#noGameEventsMessage-' + gameId);
                
                var playerName = newPenalty.player_name; // Corrected: player_name is the string from JSON

                var teamDisplayName = newPenalty.team_code; // Default to code
                // Logic to get display name from title
                var titleElement = form.closest('.card-body').find('h5:first');
                if (titleElement.length) {
                    var titleText = titleElement.text();
                    var teamsInTitle = titleText.substring(titleText.indexOf(':') + 1).split(' vs ');
                    var gameTeam1CodeInForm = $('#addPenaltyForm-' + gameId).find('#penalty_team-' + gameId + ' option:first-child').val();
                     if (newPenalty.team_code === gameTeam1CodeInForm && teamsInTitle.length > 0) {
                        teamDisplayName = teamsInTitle[0].trim();
                    } else if (teamsInTitle.length > 1) {
                        var gameTeam2CodeInForm = $('#addPenaltyForm-' + gameId).find('#penalty_team-' + gameId + ' option:nth-child(2)').val();
                        if (newPenalty.team_code === gameTeam2CodeInForm) teamDisplayName = teamsInTitle[1].trim();
                    }
                }

                var deletePenaltyFormAction = "{{ url_for('year_bp.delete_penalty', year_id=0, penalty_id=0) }}".replace('/0/penalty/0/delete', '/' + current_year_id + '/penalty/' + newPenalty.id + '/delete');

                var newEventHtml = '<li class="list-group-item event-item">' +
                    '<div class="d-flex w-100 justify-content-between">' +
                        '<h6 class="mb-1 event-time">' +
                        '<i class="fas fa-gavel text-primary mr-2"></i>' + 
                        newPenalty.minute_of_game + '</h6>' +
                        '<small>' +
                            '<form method="POST" action="' + deletePenaltyFormAction + '" style="display: inline;">' +
                                '<input type="hidden" name="game_id_anchor" value="' + gameId + '">' +
                                '<button type="submit" class="btn btn-danger btn-xs" onclick="this.form.action += \'#game-details-'+gameId+'\'; return confirm(\\\'Sicher, dass du diese Strafe löschen willst?\\\');" title="Strafe löschen">&times;</button>' +
                            '</form>' +
                        '</small>' +
                    '</div>' +
                    '<p class="mb-1">' +
                        '<strong>' + newPenalty.penalty_type + ' Strafe für ' + teamDisplayName + '</strong><br>' +
                        playerName + '<br>' + // playerName is now the correct string
                        'Grund: ' + newPenalty.reason +
                    '</p>' +
                '</li>';

                insertEventIntoSortedList(gameId, newEventHtml, newPenalty.minute_of_game);

                var currentEventCount = parseInt($('#eventCountBadge-' + gameId).text());
                $('#eventCountBadge-' + gameId).text(currentEventCount + 1);
            }
        })
        .catch(error => {
            console.error('Error adding penalty:', error);
            messageArea.html('<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                             'Kommunikationsfehler: ' + error.message +
                             '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>' +
                             '</div>');
        });
    });

    // Add SOG update logic
    function updateTotalSogDisplay(gameId, teamCode, sogDataForTeam) {
        let total = 0;
        // sogDataForTeam is an object like {1: shots_p1, 2: shots_p2, ...}
        // Or, if reading from inputs: iterate through relevant inputs for the team
        const form = document.getElementById(`sogEditForm-${gameId}`);
        if (!form) return;

        for (let p = 1; p <= 4; p++) {
            const inputName = teamCode === form.elements['sog_team1_code_resolved'].value ? `team1_p${p}_shots` : `team2_p${p}_shots`;
            const inputElement = form.elements[inputName];
            if (inputElement) {
                total += parseInt(inputElement.value) || 0;
            }
        }

        const totalDisplayCell = document.getElementById(`sog-${gameId}-${teamCode}-total-display`);
        if (totalDisplayCell) {
            totalDisplayCell.innerHTML = `<strong>${total}</strong>`;
        }
    }

    // Validate SOG for OT/SO games
    function validateSogForOvertimeGame(gameId) {
        const gameRow = $('#game-' + gameId);
        const resultTypeSelect = gameRow.find('select[name="result_type"]');
        const resultType = resultTypeSelect.val();
        
        // Check if game was decided in OT or SO
        if (resultType === 'OT' || resultType === 'SO') {
            const form = document.getElementById(`sogEditForm-${gameId}`);
            if (form) {
                const team1OtShots = parseInt(form.elements['team1_p4_shots']?.value) || 0;
                const team2OtShots = parseInt(form.elements['team2_p4_shots']?.value) || 0;
                const totalOtShots = team1OtShots + team2OtShots;
                
                if (totalOtShots === 0) {
                    return {
                        valid: false,
                        message: `Spiele nach ${resultType === 'OT' ? 'Verlängerung' : 'Penalties'} müssen mindestens 1 Schuss in der OT-Spalte haben.`
                    };
                }
            }
        }
        
        return { valid: true };
    }

    function handleSogSubmit(gameId) {
        const form = document.getElementById(`sogEditForm-${gameId}`); // Changed ID to sogEditForm-
        const messageArea = $('#sogMessageArea-' + gameId);
        
        // Validate SOG for OT/SO games before submitting
        const validationResult = validateSogForOvertimeGame(gameId);
        if (!validationResult.valid) {
            messageArea.html('<div class="alert alert-danger alert-dismissible fade show" role="alert">' + 
                           validationResult.message + 
                           '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
            return;
        }
        
        messageArea.html('<div class="alert alert-info alert-dismissible fade show" role="alert">Speichern...<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');

        const formData = new FormData(form);

        fetch(`{{ url_for('year_bp.add_sog', game_id=0) }}`.replace('0', gameId), {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Server response was not ok: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            var alertClass = data.success ? 'alert-success' : 'alert-danger';
            var msgText = data.message || (data.success ? 'SOG erfolgreich gespeichert!' : 'Fehler beim Speichern der SOG.');
            
            messageArea.html(
                '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
                msgText +
                '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>' +
                '</div>'
            );

            if (data.success) {
                const gameSogData = data.sog_data; // This is { team_code: { period: shots } }
                const team1Code = form.elements['sog_team1_code_resolved'].value;
                const team2Code = form.elements['sog_team2_code_resolved'].value;

                if (gameSogData[team1Code]) {
                    for (let p = 1; p <= 4; p++) {
                        const shots = gameSogData[team1Code][p] !== undefined ? gameSogData[team1Code][p] : 0;
                        const inputEl = form.elements[`team1_p${p}_shots`];
                        if (inputEl) inputEl.value = shots;
                    }
                    updateTotalSogDisplay(gameId, team1Code, gameSogData[team1Code]); // Pass current team's SOG for total calculation
                }
                 if (gameSogData[team2Code]) {
                    for (let p = 1; p <= 4; p++) {
                        const shots = gameSogData[team2Code][p] !== undefined ? gameSogData[team2Code][p] : 0;
                        const inputEl = form.elements[`team2_p${p}_shots`];
                        if (inputEl) inputEl.value = shots;
                    }
                    updateTotalSogDisplay(gameId, team2Code, gameSogData[team2Code]); // Pass current team's SOG for total calculation
                }
                
                // Update score match indicator after SOG update
                if (data.hasOwnProperty('scores_fully_match_goals')) {
                    updateScoreMatchIndicatorSafe(gameId, data.scores_fully_match_goals);
                }
            } else {
                // Error message is already displayed by the generic logic above
            }
        })
        .catch(error => {
            messageArea.html(
                '<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                'Netzwerkfehler oder Serverproblem: ' + error.message +
                '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>' +
                '</div>'
            );
        });
    }

    // Delegated event handler for deleting goals/penalties
    $(document).on('submit', 'form.delete-event-form', function(event) {
        event.preventDefault();
        var form = $(this);
        var gameId = form.find('input[name="game_id_anchor"]').val();
        var eventType = form.find('input[name="event_type"]').val(); // "goal" or "penalty"
        var deleteUrl = form.attr('action');
        var messageAreaId = (eventType === 'goal') ? '#goalMessageArea-' + gameId : '#penaltyMessageArea-' + gameId;
        var $messageArea = $(messageAreaId);

        if (!confirm('Sicher, dass du dieses Ereignis löschen willst?')) {
            return;
        }

        fetch(deleteUrl, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                // If you have CSRF tokens, include them here
                // 'X-CSRFToken': getCsrfToken() 
            },
            body: new FormData(form[0]) // Send form data if needed by backend, though URL params might be enough
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errData => { 
                    throw new Error(errData.message || `Serverfehler: ${response.status}`); 
                });
            }
            return response.json();
        })
        .then(data => {
            var alertClass = data.success ? 'alert-success' : 'alert-danger';
            $messageArea.html('<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
                             data.message +
                             '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>' +
                             '</div>');

            if (data.success) {
                form.closest('li.event-item').remove(); // Remove the list item
                
                // Update event count badge
                var $eventCountBadge = $('#eventCountBadge-' + gameId);
                var currentCount = parseInt($eventCountBadge.text());
                if (!isNaN(currentCount) && currentCount > 0) {
                    $eventCountBadge.text(currentCount - 1);
                }

                // If a goal was deleted, update the score match indicator
                if (eventType === 'goal' && data.hasOwnProperty('scores_fully_match_goals')) {
                    updateScoreMatchIndicatorSafe(gameId, data.scores_fully_match_goals);
                }
                // Check if the list is empty and show the "no events" message
                if ($('#gameEventsDisplayArea-' + gameId + ' ul.list-group li.event-item').length === 0) {
                    $('#noGameEventsMessage-' + gameId).removeClass('d-none');
                }
            }
        })
        .catch(error => {
            console.error('Fehler beim Löschen des Ereignisses:', error);
            $messageArea.html('<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                             'Kommunikationsfehler: ' + error.message +
                             '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>' +
                             '</div>');
        });
    });

    // Open game stats in a new window
    $(document).on('click', 'a.game-stats-link', function(event) {
        event.preventDefault();
        var url = $(this).attr('href');
        var windowName = 'gameStatsWindow'; // Gives the new window a name
        var windowFeatures = 'width=1200,height=800,scrollbars=yes,resizable=yes';
        window.open(url, windowName, windowFeatures);
    });

    // Open team vs team comparison in a new window
    $(document).on('click', 'button.team-vs-team-link', function(event) {
        event.preventDefault();
        var url = $(this).data('url');
        var windowName = $(this).data('window-name');
        var windowFeatures = 'width=1200,height=800,scrollbars=yes,resizable=yes,menubar=no,toolbar=no';
        window.open(url, windowName, windowFeatures);
    });

    // AJAX for Player Stats Team Filter
    $('#stats_team_filter').on('change', function() {
        var selectedTeam = $(this).val();
        var yearIdStr = '{{ year.id|tojson|safe }}'; 
        var yearId = JSON.parse(yearIdStr); 
        var statsDataUrl = `/year/${yearId}/stats_data?stats_team_filter=${selectedTeam}`;

        // Show some loading indicator if you have one
        // Example: $('#loadingSpinner').show();

        fetch(statsDataUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                updateStatsTable('#top-scorers-points-body', data.top_scorers_points, data.selected_team, 'points', data.team_iso_codes_from_server); // Assuming team_iso_codes is passed if needed for flags in JS
                updateStatsTable('#top-goal-scorers-body', data.top_goal_scorers, data.selected_team, 'goals', data.team_iso_codes_from_server);
                updateStatsTable('#top-assist-providers-body', data.top_assist_providers, data.selected_team, 'assists', data.team_iso_codes_from_server);
                updateStatsTable('#top-penalty-players-body', data.top_penalty_players, data.selected_team, 'pim', data.team_iso_codes_from_server);
                
                // Update headings
                var teamDisplay = data.selected_team ? ` (${data.selected_team})` : '';
                $('#top-scorers-points-section h3').text(`Top Scorer (Punkte)${teamDisplay}`);
                $('#top-goal-scorers-section h3').text(`Top Torschützen (Tore)${teamDisplay}`);
                $('#top-assist-providers-section h3').text(`Top Assistgeber (Assists)${teamDisplay}`);
                $('#top-penalty-players-section h3').text(`Meiste Strafminuten (PIM)${teamDisplay}`);

                // Update URL without reloading page (optional)
                var newUrl = window.location.pathname + (selectedTeam ? `?stats_team_filter=${selectedTeam}` : '') + window.location.hash;
                history.pushState({path:newUrl}, '', newUrl);

                // Hide loading indicator
                // $('#loadingSpinner').hide();
            })
            .catch(error => {
                console.error('Error fetching or processing stats data:', error);
                // Display error message to user
                // $('#statsErrorMessage').text('Fehler beim Laden der Statistiken.').show();
                // $('#loadingSpinner').hide();
            });
    });

    function updateStatsTable(tableBodySelector, statsData, selectedTeam, statType, teamIsoCodes) {
        var $tableBody = $(tableBodySelector);
        $tableBody.empty(); // Clear existing rows
        var $section = $tableBody.closest('.stats-section');
        var $toggleButton = $section.find('.toggle-stats-visibility');

        if (statsData && statsData.length > 0) {
            statsData.forEach(function(stat_entry, index) {
                var playerLastName = stat_entry.player_obj.last_name ? stat_entry.player_obj.last_name.toUpperCase() : '';
                var playerFirstName = stat_entry.player_obj.first_name ? stat_entry.player_obj.first_name : '';
                var teamCode = stat_entry.player_obj.team_code || 'N/A';
                var isoCode = window.TEAM_ISO_CODES_FROM_TEMPLATE ? window.TEAM_ISO_CODES_FROM_TEMPLATE[teamCode] : null; // Use global var
                var flagImg = isoCode ? `<img src="https://flagcdn.com/w20/${isoCode}.png" alt="${teamCode}" style="margin-right: 5px;">` : '';

                var rowHtml = `<tr class="${index >= 20 ? 'extra-stats-row d-none' : ''}">
                                <td>${index + 1}</td>
                                <td>${playerLastName} ${playerFirstName}</td>
                                <td>${flagImg}${teamCode}</td>`;

                if (statType === 'points') {
                    rowHtml += `<td>${stat_entry.goals}</td>
                                <td>${stat_entry.assists}</td>
                                <td><strong>${stat_entry.points}</strong></td>`;
                } else if (statType === 'goals') {
                    rowHtml += `<td><strong>${stat_entry.goals}</strong></td>`;
                } else if (statType === 'assists') {
                    rowHtml += `<td><strong>${stat_entry.assists}</strong></td>`;
                } else if (statType === 'pim') {
                    rowHtml += `<td><strong>${stat_entry.pim}</strong></td>`;
                }
                rowHtml += `</tr>`;
                $tableBody.append(rowHtml);
            });

            if (statsData.length > 20) {
                $toggleButton.text('Alle anzeigen').removeClass('d-none');
            } else {
                $toggleButton.addClass('d-none');
            }
            // Remove old no-data message if present and add if needed (covered by else)
            $section.find('.no-stats-message').remove(); 
        } else {
            $tableBody.closest('table').after('<p class="text-muted mt-2 no-stats-message">Keine Daten vorhanden' + (selectedTeam ? ` für ${selectedTeam}` : '') + '.</p>');
            $toggleButton.addClass('d-none');
        }
    }
    // Make team_iso_codes available globally for JS if needed by updateStatsTable
    // This assumes TEAM_ISO_CODES is passed to the main year_view render_template context
    var teamIsoCodesStr = '{{ team_iso_codes|tojson|safe }}';
    window.TEAM_ISO_CODES_FROM_TEMPLATE = JSON.parse(teamIsoCodesStr);

    // --- Team Stats Table Sorting ---
    function sortTeamStatsTable(columnIndex, thElement) {
        const table = document.getElementById('team-stats-table');
        const tbody = table.querySelector('#team-stats-tbody');
        if (!tbody) return;

        const rows = Array.from(tbody.querySelectorAll('tr'));
        // const sortKey = thElement.dataset.sort; // Not directly used for sorting logic here, but good for context
        
        let currentOrder = thElement.dataset.sortOrder;
        let newOrder;

        if (currentOrder === 'asc') {
            newOrder = 'desc';
        } else if (currentOrder === 'desc') {
            newOrder = 'asc';
        } else { // currentOrder is 'none' or undefined
            newOrder = 'asc'; // Default to ascending for first click
        }
        
        rows.sort((a, b) => {
            let valA = a.cells[columnIndex].textContent.trim();
            let valB = b.cells[columnIndex].textContent.trim();

            valA = parseFloat(valA);
            valB = parseFloat(valB);

            // Handle cases where parsing might result in NaN, treat as 0 or keep original string for comparison?
            // For these stats, they should always be numbers. Treating NaN as 0 for safety.
            valA = isNaN(valA) ? 0 : valA;
            valB = isNaN(valB) ? 0 : valB;

            if (newOrder === 'asc') {
                return valA - valB;
            } else {
                return valB - valA;
            }
        });

        tbody.innerHTML = ''; // Clear existing rows
        rows.forEach(row => tbody.appendChild(row));

        // Update sort icons and data attributes on all headers
        table.querySelectorAll('thead th.sortable-header').forEach(header => {
            if (header !== thElement) {
                header.dataset.sortOrder = 'none';
                header.querySelector('i').className = 'fas fa-sort';
            }
        });

        thElement.dataset.sortOrder = newOrder;
        thElement.querySelector('i').className = newOrder === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
    }

    function initialSortTeamStatsByGF() {
        const table = document.getElementById('team-stats-table');
        if (!table) return;
        const gfHeader = table.querySelector('thead th[data-sort="gf"]');
        const tbody = table.querySelector('#team-stats-tbody');

        // Always set header icons, even if tbody is empty
        table.querySelectorAll('thead th.sortable-header i').forEach(icon => icon.className = 'fas fa-sort');
        if (gfHeader) {
            gfHeader.querySelector('i').className = 'fas fa-sort-down'; // Default GF sort is descending
            gfHeader.dataset.sortOrder = 'desc';
        }

        if (gfHeader && tbody && tbody.rows.length > 0) {
            let gfColumnIndex = -1;
            const headers = Array.from(gfHeader.parentNode.children);
            for(let i=0; i<headers.length; i++) {
                if(headers[i] === gfHeader) {
                    gfColumnIndex = i;
                    break;
                }
            }

            if (gfColumnIndex !== -1) {
                const rows = Array.from(tbody.querySelectorAll('tr'));
                rows.sort((a, b) => {
                    let valA = parseFloat(a.cells[gfColumnIndex].textContent.trim()) || 0;
                    let valB = parseFloat(b.cells[gfColumnIndex].textContent.trim()) || 0;
                    return valB - valA; // GF descending by default
                });
                tbody.innerHTML = '';
                rows.forEach(row => tbody.appendChild(row));

                // Update icons
                table.querySelectorAll('thead th.sortable-header i').forEach(icon => icon.className = 'fas fa-sort');
                gfHeader.querySelector('i').className = 'fas fa-sort-down';
                gfHeader.dataset.sortOrder = 'desc'; 
            }
        }
    }

    // Attach event listeners for Team Stats Table
    const teamStatsTableElement = document.getElementById('team-stats-table');
    if (teamStatsTableElement) {
        const sortableHeaders = teamStatsTableElement.querySelectorAll('thead th.sortable-header');
        sortableHeaders.forEach(th => {
            const actualColumnIndex = Array.from(th.parentNode.children).indexOf(th);
            th.addEventListener('click', function() {
                sortTeamStatsTable(actualColumnIndex, this);
            });
        });
        
        initialSortTeamStatsByGF(); // Perform initial sort
    }
    // --- End of Team Stats Table Sorting ---

    // --- Sorting for Small Stats Tables (Scoring Eff, Goalkeeping, PP, PK) ---
    function sortSmallTableByColumn(tableId, columnIndex, thElement) {
        const table = document.getElementById(tableId);
        if (!table) return;
        const tbody = table.querySelector('tbody'); // Generic tbody selector
        if (!tbody || tbody.rows.length === 0) return;

        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        let currentOrder = thElement.dataset.sortOrder;
        let newOrder;

        if (currentOrder === 'asc') {
            newOrder = 'desc';
        } else if (currentOrder === 'desc') {
            newOrder = 'asc';
        } else { // Default to ascending for first click if no specific default for the column
            newOrder = 'asc'; 
        }
        
        rows.sort((a, b) => {
            let valAStr = a.cells[columnIndex].textContent.trim();
            let valBStr = b.cells[columnIndex].textContent.trim();
            let valA, valB;

            if (valAStr.endsWith('%')) {
                valA = parseFloat(valAStr.replace('%', ''));
                valB = parseFloat(valBStr.replace('%', ''));
            } else {
                valA = parseFloat(valAStr);
                valB = parseFloat(valBStr);
            }

            valA = isNaN(valA) ? (newOrder === 'asc' ? Infinity : -Infinity) : valA; // Handle NaN based on sort order
            valB = isNaN(valB) ? (newOrder === 'asc' ? Infinity : -Infinity) : valB;


            if (newOrder === 'asc') {
                return valA - valB;
            } else {
                return valB - valA;
            }
        });

        tbody.innerHTML = ''; // Clear existing rows
        rows.forEach(row => tbody.appendChild(row));

        table.querySelectorAll('thead th.sortable-header').forEach(header => {
            if (header !== thElement) {
                header.dataset.sortOrder = 'none';
                header.querySelector('i').className = 'fas fa-sort';
            }
        });

        thElement.dataset.sortOrder = newOrder;
        thElement.querySelector('i').className = newOrder === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
    }

    function initializeAndSortSmallTable(tableId, defaultSortColumnKey, defaultSortOrderIsDesc) {
        const table = document.getElementById(tableId);
        if (!table) return;
        
        const defaultHeader = table.querySelector(`thead th[data-sort="${defaultSortColumnKey}"]`);
        const tbody = table.querySelector('tbody');

        // Set initial icons for all sortable headers in this table
        table.querySelectorAll('thead th.sortable-header i').forEach(icon => icon.className = 'fas fa-sort');

        if (defaultHeader) {
            // Simulate a click on the default sort header to set the correct initial state and sort direction
            // The sortSmallTableByColumn function will handle setting the icon and data-sortOrder attribute
            
            // To achieve the desired default order (e.g., 'desc'), we set the 'current' state to its opposite
            // so that the sortSmallTableByColumn function flips it to the correct one.
            defaultHeader.dataset.sortOrder = defaultSortOrderIsDesc ? 'asc' : 'desc';

            let defaultColumnIndex = -1;
            const headers = Array.from(defaultHeader.parentNode.children);
            for(let i=0; i<headers.length; i++) {
                if(headers[i] === defaultHeader) {
                    defaultColumnIndex = i;
                    break;
                }
            }

            if (defaultColumnIndex !== -1 && tbody && tbody.rows.length > 0) {
                 sortSmallTableByColumn(tableId, defaultColumnIndex, defaultHeader);
            } else if (tbody && tbody.rows.length === 0) { // Still set icon if no data
                 defaultHeader.querySelector('i').className = defaultSortOrderIsDesc ? 'fas fa-sort-down' : 'fas fa-sort-up';
                 defaultHeader.dataset.sortOrder = defaultSortOrderIsDesc ? 'desc' : 'asc';
            }
        }

        // Attach event listeners for this table
        const sortableHeaders = table.querySelectorAll('thead th.sortable-header');
        sortableHeaders.forEach(th => {
            const actualColumnIndex = Array.from(th.parentNode.children).indexOf(th);
            th.addEventListener('click', function() {
                sortSmallTableByColumn(tableId, actualColumnIndex, this);
            });
        });
    }

    // Initialize small stats tables after the main team stats table is potentially initialized
    if (document.getElementById('team-stats-table')) { // Ensure main table exists before trying to init small ones
        initializeAndSortSmallTable('scoring-eff-table', 'sg_perc', true);      // Sort SG% Desc
        initializeAndSortSmallTable('goalkeeping-table', 'svs_perc', true);     // Sort SVS% Desc
        initializeAndSortSmallTable('powerplay-table', 'pp_perc', true);        // Sort PP% Desc
        initializeAndSortSmallTable('penalty-kill-table', 'pk_perc', true);     // Sort PK% Desc
    }
    // --- End of Sorting for Small Stats Tables ---

    // --- Overrule Feature JavaScript ---
    let currentGameIdForOverrule = null;
    let currentGameDataForOverrule = null;

    // Click handler for score match indicators
    $(document).on('click', '.score-match-indicator', function() {
        const gameId = $(this).data('game-id');
        const isOverruled = $(this).hasClass('overruled-indicator');
        const isInvalid = $(this).hasClass('invalid-indicator');
        
        if (isInvalid || isOverruled) {
            openOverruleModal(gameId, isOverruled);
        }
    });

    function openOverruleModal(gameId, hasExistingOverrule) {
        currentGameIdForOverrule = gameId;
        
        // Get game info from the row
        const gameRow = $('#game-' + gameId);
        const gameNumber = gameRow.find('td:first').text();
        const team1Cell = gameRow.find('td:nth-child(5)'); // Heim team cell 
        const team2Cell = gameRow.find('td:nth-child(6)'); // Gast team cell
        const team1Name = team1Cell.text().trim().split('(')[0].trim(); // Remove any (placeholder) text
        const team2Name = team2Cell.text().trim().split('(')[0].trim();
        const score1 = gameRow.find('input[name="team1_score"]').val() || '?';
        const score2 = gameRow.find('input[name="team2_score"]').val() || '?';
        
        // Set game description
        $('#overruleGameDescription').text(`Spiel ${gameNumber}: ${team1Name} vs ${team2Name} (${score1}:${score2})`);
        
        // Get warnings from current consistency check
        getCurrentWarningsForGame(gameId).then(warnings => {
            const warningsList = $('#overruleWarningsList');
            warningsList.empty();
            warnings.forEach(warning => {
                warningsList.append(`<li>${warning}</li>`);
            });
        });
        
        // Handle existing overrule
        if (hasExistingOverrule) {
            const overruleIndicator = $('.overruled-indicator[data-game-id="' + gameId + '"]');
            const existingReason = overruleIndicator.attr('title').replace('Score-Matching überregelt: ', '');
            
            $('#overruleReason').val(existingReason);
            $('#existingOverruleInfo').removeClass('d-none');
            $('#existingOverruleReason').text(existingReason);
            $('#existingOverruleDate').text(''); // We could fetch this from backend if needed
            $('#removeOverruleBtn').show();
            $('#overruleModalLabel').text('Score-Matching Überregelung bearbeiten');
        } else {
            $('#overruleReason').val('');
            $('#existingOverruleInfo').addClass('d-none');
            $('#removeOverruleBtn').hide();
            $('#overruleModalLabel').text('Score-Matching Überregeln');
        }
        
        $('#overruleModal').modal('show');
    }

    // Mock function to get current warnings - in real implementation, this would call the backend
    async function getCurrentWarningsForGame(gameId) {
        // This is a simplified version - in reality you'd make an AJAX call to get current warnings
        const indicators = $('.invalid-indicator[data-game-id="' + gameId + '"], .overruled-indicator[data-game-id="' + gameId + '"]');
        if (indicators.length > 0) {
            const title = indicators.first().attr('title');
            if (title.includes('überregelt')) {
                return ['Spiel ist derzeit überregelt'];
            } else {
                // Parse the existing warning from the title
                return [title.split('.')[0]]; // Take first sentence
            }
        }
        return ['Unbekanntes Problem mit Score-Matching'];
    }

    // Save overrule
    $('#saveOverruleBtn').on('click', function() {
        const reason = $('#overruleReason').val().trim();
        if (!reason) {
            alert('Bitte geben Sie einen Grund für die Überregelung an.');
            return;
        }
        
        const formData = new FormData();
        formData.append('reason', reason);
        
        fetch(`{{ url_for('year_bp.add_overrule', year_id=year.id, game_id=0) }}`.replace('/0/overrule', '/' + currentGameIdForOverrule + '/overrule'), {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the indicator
                updateScoreMatchIndicator(currentGameIdForOverrule, 'overruled', reason);
                $('#overruleModal').modal('hide');
                
                // Show success message
                showTemporaryMessage('success', data.message);
            } else {
                alert('Fehler: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error saving overrule:', error);
            alert('Netzwerkfehler beim Speichern der Überregelung.');
        });
    });

    // Remove overrule
    $('#removeOverruleBtn').on('click', function() {
        if (!confirm('Sind Sie sicher, dass Sie die Überregelung entfernen möchten?')) {
            return;
        }
        
        fetch(`{{ url_for('year_bp.remove_overrule', year_id=year.id, game_id=0) }}`.replace('/0/overrule', '/' + currentGameIdForOverrule + '/overrule'), {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the indicator to show normal validation state
                updateScoreMatchIndicator(currentGameIdForOverrule, 'normal');
                $('#overruleModal').modal('hide');
                
                // Show success message
                showTemporaryMessage('success', data.message);
            } else {
                alert('Fehler: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error removing overrule:', error);
            alert('Netzwerkfehler beim Entfernen der Überregelung.');
        });
    });

    function updateScoreMatchIndicator(gameId, state, reason = '') {
        const container = $('#scoreMatchIndicatorContainer-' + gameId);
        let newHtml = '';
        
        if (state === 'overruled') {
            newHtml = `<span class="text-warning score-match-indicator overruled-indicator" data-game-id="${gameId}" style="cursor: pointer;" title="Score-Matching überregelt: ${reason}">
                        <i class="fas fa-exclamation-triangle"></i>
                       </span>`;
        } else {
            // Check if the game would normally be valid or invalid
            // This is simplified - in reality you'd check the actual validation state
            const gameRow = $('#game-' + gameId);
            const score1 = gameRow.find('input[name="team1_score"]').val();
            const score2 = gameRow.find('input[name="team2_score"]').val();
            
            if (score1 !== '' && score2 !== '') {
                // For now, assume it goes back to invalid state when overrule is removed
                // In reality, you'd need to re-check the validation
                newHtml = `<span class="text-danger score-match-indicator invalid-indicator" data-game-id="${gameId}" style="cursor: pointer;" title="Spielstand und erfasste Tore stimmen NICHT überein, SOG-Daten fehlen für P1-P3, Overtime-Regeln verletzt (Tore nach 60:00 erfordern n.V. und Tordifferenz von 1), oder Powerplay-/Penalty-Situationen sind inkonsistent (PP/SH-Tore bei aktiven Strafen, Sonderregeln für 5+Spieldauer und 2+2 Min beachtet). Klicken zum Überregeln.">✗</span>`;
            } else {
                newHtml = '';
            }
        }
        
        container.html(newHtml);
    }

    function showTemporaryMessage(type, message) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const messageHtml = `<div class="alert ${alertClass} alert-dismissible fade show fixed-top" style="z-index: 9999; margin: 10px;" role="alert">
                                ${message}
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                             </div>`;
        $('body').prepend(messageHtml);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            $('.alert.fixed-top').alert('close');
        }, 5000);
    }
    // --- End of Overrule Feature JavaScript ---

    // --- Semifinal Seeding Adjustment Feature ---
    let currentSemifinalTeams = [];
    let originalSeeding = {};
    
    // Initialize seeding form when collapse is shown
    $('#semifinalSeedingAdjust').on('show.bs.collapse', function () {
        initializeSeedingForm();
    });

    function initializeSeedingForm() {
        // Get current semifinal teams and their seeding
        getCurrentSemifinalTeams().then(teams => {
            currentSemifinalTeams = teams;
            originalSeeding = {...teams.seeding};
            
            populateSeedingDropdowns(teams.resolved_teams);
            displayCurrentSeeding(teams.seeding);
            setInitialSeedingValues(teams.seeding);
        });
    }

    async function getCurrentSemifinalTeams() {
        // Get current seeding from server
        try {
            const response = await fetch(`/year/${current_year_id}/semifinal_seeding`);
            const data = await response.json();
            
            if (data.success && data.seeding && data.resolved_teams) {
                return {
                    resolved_teams: data.resolved_teams,
                    seeding: data.seeding
                };
            } else {
                // Fallback: extract teams from current page if server data not available
                return extractTeamsFromPage();
            }
        } catch (error) {
            console.error('Error fetching current seeding:', error);
            // Fallback: extract teams from current page
            return extractTeamsFromPage();
        }
    }

    function extractTeamsFromPage() {
        let resolvedTeams = [];
        let seeding = {};
        
        // Extract teams from the current semifinals section
        const semifinalsTab = $('#semifinals');
        const gameRows = semifinalsTab.find('tbody tr[id^="game-"]');
        
        gameRows.each(function(index) {
            const team1Cell = $(this).find('td:nth-child(5)'); // Heim team cell
            const team2Cell = $(this).find('td:nth-child(7)'); // Gast team cell
            
            if (team1Cell.length && team2Cell.length) {
                let team1Name = team1Cell.text().trim().split('(')[0].trim();
                let team2Name = team2Cell.text().trim().split('(')[0].trim();
                
                // Remove any flag icons or extra text
                team1Name = team1Name.replace(/^\s*\S+\s+/, ''); // Remove first word if it's likely a flag
                team2Name = team2Name.replace(/^\s*\S+\s+/, ''); // Remove first word if it's likely a flag
                
                if (team1Name && team2Name && 
                    window.TEAM_ISO_CODES_FROM_TEMPLATE[team1Name] && 
                    window.TEAM_ISO_CODES_FROM_TEMPLATE[team2Name]) {
                    resolvedTeams.push(team1Name, team2Name);
                }
            }
        });
        
        // Remove duplicates
        resolvedTeams = [...new Set(resolvedTeams)];
        
        if (resolvedTeams.length >= 4) {
            // Assign seeding based on current order as fallback
            resolvedTeams.forEach((team, index) => {
                seeding[`seed${index + 1}`] = team;
            });
        }
        
        return {
            resolved_teams: resolvedTeams,
            seeding: seeding
        };
    }

    function populateSeedingDropdowns(teams) {
        const seedSelects = ['#seed1', '#seed2', '#seed3', '#seed4'];
        
        seedSelects.forEach(selectId => {
            const $select = $(selectId);
            $select.empty().append('<option value="">Team wählen...</option>');
            
            teams.forEach(team => {
                const isoCode = window.TEAM_ISO_CODES_FROM_TEMPLATE[team];
                const flagImg = isoCode ? `🏴 ` : '';
                $select.append(`<option value="${team}">${flagImg}${team}</option>`);
            });
        });
    }

    function displayCurrentSeeding(seeding) {
        let html = '<div class="list-group list-group-flush">';
        
        for (let i = 1; i <= 4; i++) {
            const team = seeding[`seed${i}`] || '-';
            const isoCode = window.TEAM_ISO_CODES_FROM_TEMPLATE[team];
            const flagImg = isoCode ? `<img src="https://flagcdn.com/w20/${isoCode}.png" alt="${team}" style="margin-right: 5px;">` : '';
            
            html += `<div class="list-group-item py-1 px-2">
                        <strong>${i}. Seed:</strong> ${flagImg}${team}
                     </div>`;
        }
        
        html += '</div>';
        html += '<div class="mt-2 small text-muted">';
        html += '<strong>Aktuelle Paarungen:</strong><br>';
        html += `Spiel 1: ${seeding.seed1 || '-'} vs ${seeding.seed4 || '-'}<br>`;
        html += `Spiel 2: ${seeding.seed2 || '-'} vs ${seeding.seed3 || '-'}`;
        html += '</div>';
        
        $('#currentSeedingDisplay').html(html);
    }

    function setInitialSeedingValues(seeding) {
        $('#seed1').val(seeding.seed1 || '');
        $('#seed2').val(seeding.seed2 || '');
        $('#seed3').val(seeding.seed3 || '');
        $('#seed4').val(seeding.seed4 || '');
        
        updatePairingsPreview();
    }

    // Update pairings preview when dropdown values change
    $('#seed1, #seed2, #seed3, #seed4').on('change', function() {
        updatePairingsPreview();
        validateSeedingSelection();
    });

    function updatePairingsPreview() {
        const seed1 = $('#seed1').val();
        const seed2 = $('#seed2').val();
        const seed3 = $('#seed3').val();
        const seed4 = $('#seed4').val();
        
        $('#seed1Display').text(seed1 || '-');
        $('#seed2Display').text(seed2 || '-');
        $('#seed3Display').text(seed3 || '-');
        $('#seed4Display').text(seed4 || '-');
    }

    function validateSeedingSelection() {
        const seeds = [$('#seed1').val(), $('#seed2').val(), $('#seed3').val(), $('#seed4').val()];
        const uniqueSeeds = new Set(seeds.filter(seed => seed !== ''));
        
        // Check for duplicates
        const hasDuplicates = uniqueSeeds.size !== seeds.filter(seed => seed !== '').length;
        const allSelected = seeds.every(seed => seed !== '');
        
        const submitBtn = $('#adjustSeedingForm button[type="submit"]');
        
        if (hasDuplicates) {
            showSeedingMessage('warning', 'Jedes Team kann nur einmal ausgewählt werden.');
            submitBtn.prop('disabled', true);
        } else if (!allSelected) {
            $('#seedingMessageArea').empty();
            submitBtn.prop('disabled', true);
        } else {
            $('#seedingMessageArea').empty();
            submitBtn.prop('disabled', false);
        }
    }

    // Reset seeding to original values
    $('#resetSeedingBtn').on('click', function() {
        if (confirm('Möchten Sie das Seeding auf die Standard IIHF-Regeln zurücksetzen? Dies löscht alle manuellen Anpassungen.')) {
            // Call DELETE route to reset to standard seeding
            fetch(`/year/${current_year_id}/semifinal_seeding`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSeedingMessage('success', data.message || 'Seeding wurde auf Standard-Regeln zurückgesetzt.');
                    
                    // Reload the page to show updated seeding
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showSeedingMessage('danger', data.message || 'Fehler beim Zurücksetzen des Seedings.');
                }
            })
            .catch(error => {
                console.error('Error resetting seeding:', error);
                showSeedingMessage('danger', 'Netzwerkfehler beim Zurücksetzen des Seedings.');
            });
        }
    });

    // Handle seeding form submission
    $('#adjustSeedingForm').on('submit', function(event) {
        event.preventDefault();
        
        const seedingData = {
            seeding: {
                seed1: $('#seed1').val(),
                seed2: $('#seed2').val(),
                seed3: $('#seed3').val(),
                seed4: $('#seed4').val()
            }
        };
        
        // Show loading message
        showSeedingMessage('info', 'Seeding wird gespeichert...');
        
        fetch(`/year/${current_year_id}/semifinal_seeding`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(seedingData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSeedingMessage('success', data.message || 'Seeding wurde erfolgreich geändert!');
                
                // Update the original seeding for reset functionality
                originalSeeding = {
                    seed1: seedingData.seeding.seed1,
                    seed2: seedingData.seeding.seed2,
                    seed3: seedingData.seeding.seed3,
                    seed4: seedingData.seeding.seed4
                };
                
                // Reload the page after a short delay to show updated pairings
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showSeedingMessage('danger', data.message || 'Fehler beim Speichern des Seedings.');
            }
        })
        .catch(error => {
            console.error('Error adjusting seeding:', error);
            showSeedingMessage('danger', 'Netzwerkfehler beim Speichern des Seedings.');
        });
    });

    function showSeedingMessage(type, message) {
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'warning' ? 'alert-warning' : 
                          type === 'info' ? 'alert-info' : 'alert-danger';
        
        const messageHtml = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                                ${message}
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                             </div>`;
        
        $('#seedingMessageArea').html(messageHtml);
        
        // Auto-dismiss success messages after 3 seconds
        if (type === 'success') {
            setTimeout(() => {
                $('#seedingMessageArea .alert').alert('close');
            }, 3000);
        }
    }
    // --- End of Semifinal Seeding Adjustment Feature ---

});
</script>
{% endblock %} 