{% extends 'base.html' %}

{% block title %}Spielstatistik: {{ game.team1_code }} vs {{ game.team2_code }} - {{ year.name }}{% endblock %}

{% block navbar %}
{% endblock navbar %}

{% block head_scripts %}
{{ super() }}
<style>
    .stat-bar-container {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        font-size: 0.9rem;
    }
    .stat-bar-label {
        width: 30px; /* Adjust as needed */
        text-align: right;
        padding-right: 10px;
        font-weight: bold;
    }
    .stat-bar-team1 {
        height: 20px;
        background-color: #007bff; /* Blue for Team 1 */
        color: white;
        text-align: right;
        padding-right: 5px;
        line-height: 20px;
        border-top-left-radius: 3px;
        border-bottom-left-radius: 3px;
    }
    .stat-bar-team2 {
        height: 20px;
        background-color: #dc3545; /* Red for Team 2 */
        color: white;
        text-align: left;
        padding-left: 5px;
        line-height: 20px;
        border-top-right-radius: 3px;
        border-bottom-right-radius: 3px;
    }
    .stat-bar-middle-label {
        padding: 0 15px;
        font-weight: bold;
        color: #6c757d;
        font-size: 0.8rem;
        white-space: nowrap;
    }
    .nav-pills .nav-link.active, .nav-pills .show>.nav-link {
        background-color: #007bff;
    }
    .nav-pills .nav-link {
        color: #007bff;
    }
    .card-header-pills {
        margin-right: -0.75rem;
        margin-left: -0.75rem;
    }
    .game-stats-content-wrapper {
        padding-top: 1.5rem;
        width: 100%;
    }
    .scoring-summary-column { /* Just a marker class, no specific style needed if list is handled */
    }
    .scoring-summary-list { /* THIS div should ONLY wrap the actual list of goals */
        padding-right: 0; /* Was for scrollbar */
    }
    /* Minimal styles for debugging if needed */
    /* .row { border: 1px solid green; } */
    /* .scoring-summary-column { border: 1px dashed blue; } */
    /* .team-stats-column { border: 1px dashed purple; } */
</style>
{% endblock %}

{% block content %}
<div class="game-stats-content-wrapper">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Spielstatistik</h1>
        {# <a href="{{ url_for('year_view', year_id=year.id, _anchor='game-' + game.id|string) }}" class="btn btn-secondary">&laquo; Zurück zur Jahresansicht</a> #} {# Removed back button #}
    </div>

    <!-- 1. Game Header (from old col-md-7 card-header) -->
    <div class="card mb-4"> {# Using a card for grouping, can be styled as needed #}
        <div class="card-header">
            <div class="row align-items-center"> {# Keep inner row for alignment if desired #}
                <div class="col-md-4 text-center text-md-left">
                    {% set t1_iso = team_iso_codes.get(game.team1_code) %}
                    {% if t1_iso %}<img src="https://flagcdn.com/w40/{{ t1_iso }}.png" alt="{{ game.team1_code }}" class="mr-2">{% endif %}
                    <span class="h4">{{ game.team1_code }}</span>
                </div>
                <div class="col-md-4 text-center">
                    <span class="h3">{{ game.team1_score|default(0) }} - {{ game.team2_score|default(0) }}</span>
                    <div class="text-muted small">
                        {{ game.round }} {% if game.group %}(Gruppe {{ game.group }}){% endif %}<br>
                        {{ game.date.split('-') | reverse | join('.') }} - {{ game.start_time }}
                    </div>
                </div>
                <div class="col-md-4 text-center text-md-right">
                    <span class="h4">{{ game.team2_code }}</span>
                    {% set t2_iso = team_iso_codes.get(game.team2_code) %}
                    {% if t2_iso %}<img src="https://flagcdn.com/w40/{{ t2_iso }}.png" alt="{{ game.team2_code }}" class="ml-2">{% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Period Scores Table (from old col-md-5) -->
    <div class="mb-3">
        <h4 class="mb-2">Periodenübersicht</h4> {# Added a title for this section #}
        <table class="table table-sm table-bordered text-center fixed-table-layout">
            <thead class="thead-light">
                <tr>
                    <th style="width: 25%;">Teams</th>
                    <th style="width: 15%;">1</th>
                    <th style="width: 15%;">2</th>
                    <th style="width: 15%;">3</th>
                    {% if team1_scores_by_period[4] > 0 or team2_scores_by_period[4] > 0 %}
                    <th style="width: 15%;">OT</th>
                    {% endif %}
                    <th style="width: 15%;">TOT</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="text-left pl-2">
                        {% set t1_iso = team_iso_codes.get(game.team1_code) %}
                        {% if t1_iso %}<img src="https://flagcdn.com/w20/{{ t1_iso }}.png" alt="{{ game.team1_code }}" class="mr-2" style="vertical-align: middle;">{% endif %}
                        {{ game.team1_code }}
                    </td>
                    <td>{{ team1_scores_by_period[1] }}</td>
                    <td>{{ team1_scores_by_period[2] }}</td>
                    <td>{{ team1_scores_by_period[3] }}</td>
                    {% if team1_scores_by_period[4] > 0 or team2_scores_by_period[4] > 0 %}
                    <td>{{ team1_scores_by_period[4] }}</td>
                    {% endif %}
                    <td><strong>{{ game.team1_score|default(0) }}</strong></td>
                </tr>
                <tr>
                    <td class="text-left pl-2">
                        {% set t2_iso = team_iso_codes.get(game.team2_code) %}
                        {% if t2_iso %}<img src="https://flagcdn.com/w20/{{ t2_iso }}.png" alt="{{ game.team2_code }}" class="mr-2" style="vertical-align: middle;">{% endif %}
                        {{ game.team2_code }}
                    </td>
                    <td>{{ team2_scores_by_period[1] }}</td>
                    <td>{{ team2_scores_by_period[2] }}</td>
                    <td>{{ team2_scores_by_period[3] }}</td>
                    {% if team1_scores_by_period[4] > 0 or team2_scores_by_period[4] > 0 %}
                    <td>{{ team2_scores_by_period[4] }}</td>
                    {% endif %}
                    <td><strong>{{ game.team2_score|default(0) }}</strong></td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- 3. Team Statistics Tabs (from old col-md-7 card-body) -->
    <div class="card mb-4"> {# Kept card for visual grouping of stats tabs #}
        <div class="card-body">
             <h4 class="mb-3 text-center">Team-Statistiken</h4> {# Added a title for this section #}
            <ul class="nav nav-pills card-header-pills justify-content-center mb-3" id="statsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <a class="nav-link active" id="total-tab" data-toggle="tab" href="#total" role="tab" aria-controls="total" aria-selected="true">Total</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="p1-tab" data-toggle="tab" href="#p1" role="tab" aria-controls="p1" aria-selected="false">1st Period</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="p2-tab" data-toggle="tab" href="#p2" role="tab" aria-controls="p2" aria-selected="false">2nd Period</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="p3-tab" data-toggle="tab" href="#p3" role="tab" aria-controls="p3" aria-selected="false">3rd Period</a>
                </li>
                {% if sog_data_for_stats_page[game.team1_code].get(4, 0) > 0 or sog_data_for_stats_page[game.team2_code].get(4, 0) > 0 %}
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="ot-tab" data-toggle="tab" href="#ot" role="tab" aria-controls="ot" aria-selected="false">Overtime</a>
                </li>
                {% endif %}
            </ul>

            <div class="tab-content" id="statsTabsContent">
                {% macro render_stat_bar(team1_val, team2_val, label) %}
                    {% set total_val = team1_val + team2_val %}
                    {% if total_val == 0 %}{% set total_val = 1 %}{% endif %} {# Avoid division by zero #}
                    {% set team1_perc = (team1_val / total_val) * 100 %}
                    {% set team2_perc = (team2_val / total_val) * 100 %}
                    <div class="stat-bar-container">
                        <div class="stat-bar-label">{{ team1_val }}</div>
                        <div class="flex-grow-1 d-flex">
                            <div class="stat-bar-team1" style="width: {{ team1_perc }}%;"></div>
                            <div class="stat-bar-team2" style="width: {{ team2_perc }}%;"></div>
                        </div>
                        <div class="stat-bar-label" style="text-align: left; padding-left: 10px; padding-right:0;">{{ team2_val }}</div>
                    </div>
                    <div class="text-center stat-bar-middle-label">{{ label }}</div>
                {% endmacro %}

                <!-- Total Stats Tab -->
                <div class="tab-pane fade show active" id="total" role="tabpanel" aria-labelledby="total-tab">
                    <h5 class="text-center mt-3">Gesamtstatistik</h5>
                    {{ render_stat_bar(sog_totals[game.team1_code], sog_totals[game.team2_code], 'SHOTS') }}
                    {{ render_stat_bar(pim_totals[game.team1_code], pim_totals[game.team2_code], 'PIM') }}
                    
                    <hr class="my-3">
                    <h6 class="text-center text-muted">Power Play</h6>
                    <div class="row justify-content-center">
                        <div class="col-auto text-center px-3">
                            <span class="h5">{{ pp_percentage[game.team1_code] }}%</span><br>
                            <small class="text-muted">({{ pp_goals_scored[game.team1_code] }} / {{ pp_opportunities[game.team1_code] }})</small><br>
                            <small>{{ game.team1_code }}</small>
                        </div>
                        <div class="col-auto text-center px-3">
                            <span class="h5">{{ pp_percentage[game.team2_code] }}%</span><br>
                            <small class="text-muted">({{ pp_goals_scored[game.team2_code] }} / {{ pp_opportunities[game.team2_code] }})</small><br>
                            <small>{{ game.team2_code }}</small>
                        </div>
                    </div>
                </div>

                <!-- Period 1 Stats Tab -->
                <div class="tab-pane fade" id="p1" role="tabpanel" aria-labelledby="p1-tab">
                    <h5 class="text-center mt-3">1. Drittel</h5>
                    {{ render_stat_bar(sog_data_for_stats_page[game.team1_code].get(1,0), sog_data_for_stats_page[game.team2_code].get(1,0), 'SHOTS') }}
                </div>

                <!-- Period 2 Stats Tab -->
                <div class="tab-pane fade" id="p2" role="tabpanel" aria-labelledby="p2-tab">
                    <h5 class="text-center mt-3">2. Drittel</h5>
                    {{ render_stat_bar(sog_data_for_stats_page[game.team1_code].get(2,0), sog_data_for_stats_page[game.team2_code].get(2,0), 'SHOTS') }}
                </div>

                <!-- Period 3 Stats Tab -->
                <div class="tab-pane fade" id="p3" role="tabpanel" aria-labelledby="p3-tab">
                    <h5 class="text-center mt-3">3. Drittel</h5>
                    {{ render_stat_bar(sog_data_for_stats_page[game.team1_code].get(3,0), sog_data_for_stats_page[game.team2_code].get(3,0), 'SHOTS') }}
                </div>

                <!-- Overtime Stats Tab (conditional) -->
                {% if sog_data_for_stats_page[game.team1_code].get(4, 0) > 0 or sog_data_for_stats_page[game.team2_code].get(4, 0) > 0 %}
                <div class="tab-pane fade" id="ot" role="tabpanel" aria-labelledby="ot-tab">
                    <h5 class="text-center mt-3">Overtime</h5>
                    {{ render_stat_bar(sog_data_for_stats_page[game.team1_code].get(4,0), sog_data_for_stats_page[game.team2_code].get(4,0), 'SHOTS') }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 4. Scoring Summary (from old col-md-5) -->
    <div class="mb-4"> {# Wrapper for scoring summary section #}
        <h4 class="mb-3">Scoring Summary</h4>
        {% if game_events %}
            <div class="scoring-summary-list">
                {% set ns = namespace(current_period='') %}
                {% for event in game_events %}
                    {% if event.type == 'goal' %}
                        {% set trimmed_period_display = event.period_display | trim %}
                        {% if trimmed_period_display != ns.current_period %}
                            {% if ns.current_period != '' %}
                                </div> {# Close previous period-goals-container #}
                            {% endif %}
                            <div class="text-center my-2 py-1 bg-light text-muted font-weight-bold small text-uppercase period-header-item">{{ trimmed_period_display }}</div>
                            <div class="period-goals-container"> {# Open container for this period's goals #}
                            {% set ns.current_period = trimmed_period_display %}
                        {% endif %}
                        <div class="goal-event-item mb-2 p-2 border-bottom">
                            <div class="row align-items-center"> 
                                <div class="col-2 text-center pr-0">
                                    <span class="goal-time d-block small text-muted">{{ event.time_str }}</span>
                                </div>
                                <div class="col-10 goal-scorer-details">
                                    <div class="d-flex align-items-center">
                                        <strong class="scorer-name">
                                            {% if event.scorer_obj and event.scorer_obj.jersey_number is not none %}
                                                <span class="jersey-number mr-1">{{ event.scorer_obj.jersey_number }}</span>
                                            {% endif %}
                                            {{ event.scorer }}
                                        </strong>
                                        <span class="goal-type small text-muted ml-2">
                                            ({{ event.goal_type_display }}{% if event.is_empty_net %}, EN{% endif %})
                                        </span>
                                        {% if event.team_iso %}<img src="https://flagcdn.com/w20/{{ event.team_iso }}.png" alt="{{ event.team_code }}" class="ml-2" style="vertical-align: middle; height: 16px;">{% endif %}
                                    </div>
                                    <div class="assists small text-muted mt-1" style="padding-left: 5px;">
                                        {% if event.assist1 %}
                                            {% if event.assist1_obj and event.assist1_obj.jersey_number is not none %}#{{ event.assist1_obj.jersey_number }}{% endif %} {{ event.assist1 }}
                                            {% if event.assist2 %}
                                                <span class="mx-1"></span> {% if event.assist2_obj and event.assist2_obj.jersey_number is not none %}#{{ event.assist2_obj.jersey_number }}{% endif %} {{ event.assist2 }}
                                            {% endif %}
                                        {% else %}
                                            Unassisted
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
                {% if ns.current_period != '' %} {# Check if the last period-goals-container needs closing #}
                    </div>{# Close last period-goals-container #}
                {% endif %}
            </div>
        {% else %}
            <p class="text-muted">No goals scored in this game.</p>
        {% endif %}
    </div>

</div> {# End of game-stats-content-wrapper #}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    $(document).ready(function(){
        // Activate tab from URL hash if present
        var hash = window.location.hash;
        if (hash) {
            $('#statsTabs a[href="' + hash + '"]').tab('show');
        }

        // Change URL hash on tab click
        $('#statsTabs a').on('shown.bs.tab', function (e) {
            if(history.pushState) {
                history.pushState(null, null, e.target.hash);
            } else {
                window.location.hash = e.target.hash; // Fallback
            }
        });
    });
</script>
{% endblock %} 