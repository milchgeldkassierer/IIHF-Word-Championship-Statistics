{% extends "base.html" %}

{% block title %}Spielerstatistiken - IIHF WM Tracker{% endblock %}

{% block head_scripts %}
<style>
    .sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
    }
    
    .sortable:hover {
        background-color: rgba(0, 0, 0, 0.1);
    }
    
    .sortable::after {
        content: ' ↕';
        font-size: 0.8em;
        color: #999;
    }
    
    .sortable.asc::after {
        content: ' ↑';
        color: #007bff;
    }
    
    .sortable.desc::after {
        content: ' ↓';
        color: #007bff;
    }
    
    .filter-section {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
    }
    
    .stats-section {
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: box-shadow 0.3s ease;
    }
    
    .stats-section:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .stats-title {
        color: #495057;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
        margin-bottom: 20px;
        font-weight: 600;
    }
    
    /* Dark mode improvements */
    body.dark-mode .filter-section {
        background-color: #2d3748;
        border-color: #4a5568;
        color: #e2e8f0;
    }
    
    body.dark-mode .stats-section {
        background-color: #2d3748;
        border-color: #4a5568;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    body.dark-mode .stats-section:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    
    body.dark-mode .stats-title {
        color: #e2e8f0;
        border-bottom-color: #4299e1;
    }
    
    body.dark-mode .form-label {
        color: #e2e8f0;
    }
    
    body.dark-mode .table {
        background-color: transparent;
    }
    
    body.dark-mode .table th,
    body.dark-mode .table td {
        border-color: #4a5568;
        color: #e2e8f0;
    }
    
    body.dark-mode .table .thead-dark th {
        background-color: #1a202c;
        border-color: #1a202c;
        color: #e2e8f0;
    }
    
    body.dark-mode .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(255, 255, 255, 0.05);
    }
    
    body.dark-mode .table-hover tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    body.dark-mode .sortable:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    body.dark-mode .sortable::after {
        color: #a0aec0;
    }
    
    body.dark-mode .sortable.asc::after,
    body.dark-mode .sortable.desc::after {
        color: #4299e1;
    }
    
    /* Ensure player names stay on one line */
    .table td:first-child {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Spielerstatistiken</h1>

    <!-- Filter Section -->
    <div class="filter-section">
        <div class="row">
            <div class="col-md-4">
                <label for="teamFilter" class="form-label">Team auswählen:</label>
                <select id="teamFilter" class="form-control">
                    <option value="">Alle Teams</option>
                    {% set teams = [] %}
                    {% for player in player_stats %}
                        {% if player.team_code and player.team_code not in teams %}
                            {% set _ = teams.append(player.team_code) %}
                        {% endif %}
                    {% endfor %}
                    {% for team in teams|sort %}
                        <option value="{{ team }}">
                            {{ team }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <!-- Top Scorers (Points) - Full Width -->
    <div class="row">
        <div class="col-md-12">
            <div class="stats-section">
                <h3 class="stats-title">Top Scorer (Punkte)</h3>
                <div class="table-responsive">
                    <table id="scoringStatsTable" class="table table-striped table-hover table-sm">
                        <thead class="thead-dark">
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Team</th>
                                <th class="sortable" data-column="goals">Tore</th>
                                <th class="sortable" data-column="assists">Assists</th>
                                <th class="sortable" data-column="scorer_points">Punkte</th>
                            </tr>
                        </thead>
                        <tbody id="top-scorers-points-body">
                            {% for player in player_stats %}
                                {% if player.scorer_points > 0 %}
                                <tr data-team="{{ player.team_code if player.team_code else '' }}" {% if loop.index > 20 %}class="extra-stats-row d-none"{% endif %}>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ player.last_name|upper }} {{ player.first_name }}</td>
                                    <td>
                                        {% if player.team_code and team_iso_codes.get(player.team_code) %}
                                            <img src="https://flagcdn.com/w20/{{ team_iso_codes[player.team_code] }}.png" alt="{{ player.team_code }}" style="margin-right: 5px;"> 
                                        {% endif %}
                                        {{ player.team_code if player.team_code else 'N/A' }}
                                    </td>
                                    <td data-value="{{ player.goals }}">{{ player.goals }}</td>
                                    <td data-value="{{ player.assists }}">{{ player.assists }}</td>
                                    <td data-value="{{ player.scorer_points }}"><strong>{{ player.scorer_points }}</strong></td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                    {% set scorer_count = player_stats | selectattr('scorer_points', 'greaterthan', 0) | list | length %}
                    {% if scorer_count > 20 %}
                    <button class="btn btn-sm btn-outline-secondary toggle-stats-visibility" data-target-body="#top-scorers-points-body">Alle anzeigen</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Goals and Assists Side by Side -->
    <div class="row">
        <!-- Top Goal Scorers (Tore) -->
        <div class="col-lg-6">
            <div class="stats-section">
                <h3 class="stats-title">Top Torschützen (Tore)</h3>
                <div class="table-responsive">
                    <table id="goalScorersTable" class="table table-striped table-hover table-sm">
                        <thead class="thead-dark">
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Team</th>
                                <th class="sortable" data-column="goals">Tore</th>
                            </tr>
                        </thead>
                        <tbody id="top-goal-scorers-body">
                            {% for player in player_stats %}
                                {% if player.goals > 0 %}
                                <tr data-team="{{ player.team_code if player.team_code else '' }}" {% if loop.index > 20 %}class="extra-stats-row d-none"{% endif %}>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ player.last_name|upper }} {{ player.first_name }}</td>
                                    <td>
                                        {% if player.team_code and team_iso_codes.get(player.team_code) %}
                                            <img src="https://flagcdn.com/w20/{{ team_iso_codes[player.team_code] }}.png" alt="{{ player.team_code }}" style="margin-right: 5px;"> 
                                        {% endif %}
                                        {{ player.team_code if player.team_code else 'N/A' }}
                                    </td>
                                    <td data-value="{{ player.goals }}"><strong>{{ player.goals }}</strong></td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                    {% set goal_count = player_stats | selectattr('goals', 'greaterthan', 0) | list | length %}
                    {% if goal_count > 20 %}
                    <button class="btn btn-sm btn-outline-secondary toggle-stats-visibility" data-target-body="#top-goal-scorers-body">Alle anzeigen</button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Top Assist Providers (Assists) -->
        <div class="col-lg-6">
            <div class="stats-section">
                <h3 class="stats-title">Top Assistgeber (Assists)</h3>
                <div class="table-responsive">
                    <table id="assistProvidersTable" class="table table-striped table-hover table-sm">
                        <thead class="thead-dark">
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Team</th>
                                <th class="sortable" data-column="assists">Assists</th>
                            </tr>
                        </thead>
                        <tbody id="top-assist-providers-body">
                            {% for player in player_stats %}
                                {% if player.assists > 0 %}
                                <tr data-team="{{ player.team_code if player.team_code else '' }}" {% if loop.index > 20 %}class="extra-stats-row d-none"{% endif %}>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ player.last_name|upper }} {{ player.first_name }}</td>
                                    <td>
                                        {% if player.team_code and team_iso_codes.get(player.team_code) %}
                                            <img src="https://flagcdn.com/w20/{{ team_iso_codes[player.team_code] }}.png" alt="{{ player.team_code }}" style="margin-right: 5px;"> 
                                        {% endif %}
                                        {{ player.team_code if player.team_code else 'N/A' }}
                                    </td>
                                    <td data-value="{{ player.assists }}"><strong>{{ player.assists }}</strong></td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                    {% set assist_count = player_stats | selectattr('assists', 'greaterthan', 0) | list | length %}
                    {% if assist_count > 20 %}
                    <button class="btn btn-sm btn-outline-secondary toggle-stats-visibility" data-target-body="#top-assist-providers-body">Alle anzeigen</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- PIM Statistics - Full Width -->
    <div class="row">
        <div class="col-md-12">
            <div class="stats-section">
                <h3 class="stats-title">Strafminuten (PIMs)</h3>
                <div class="table-responsive">
                    <table id="pimsStatsTable" class="table table-striped table-hover table-sm">
                        <thead class="thead-dark">
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Team</th>
                                <th class="sortable" data-column="pims">PIMs</th>
                            </tr>
                        </thead>
                        <tbody id="top-penalty-players-body">
                            {% for player in player_stats %}
                                {% if player.pims > 0 %}
                                <tr data-team="{{ player.team_code if player.team_code else '' }}" {% if loop.index > 20 %}class="extra-stats-row d-none"{% endif %}>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ player.last_name|upper }} {{ player.first_name }}</td>
                                    <td>
                                        {% if player.team_code and team_iso_codes.get(player.team_code) %}
                                            <img src="https://flagcdn.com/w20/{{ team_iso_codes[player.team_code] }}.png" alt="{{ player.team_code }}" style="margin-right: 5px;"> 
                                        {% endif %}
                                        {{ player.team_code if player.team_code else 'N/A' }}
                                    </td>
                                    <td data-value="{{ player.pims }}"><strong>{{ player.pims }}</strong></td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                    {% set pim_count = player_stats | selectattr('pims', 'greaterthan', 0) | list | length %}
                    {% if pim_count > 20 %}
                    <button class="btn btn-sm btn-outline-secondary toggle-stats-visibility" data-target-body="#top-penalty-players-body">Alle anzeigen</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    let currentSort = { 
        scoring: { column: null, direction: 'asc' },
        goals: { column: null, direction: 'asc' },
        assists: { column: null, direction: 'asc' },
        pims: { column: null, direction: 'asc' }
    };
    
    // Sorting functionality for all tables
    function setupSorting(tableId, sortKey) {
        $(`#${tableId} .sortable`).click(function() {
            const column = $(this).data('column');
            const table = $(`#${tableId} tbody`);
            const rows = table.find('tr').toArray();
            
            // Determine sort direction
            if (currentSort[sortKey].column === column) {
                currentSort[sortKey].direction = currentSort[sortKey].direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort[sortKey].direction = 'desc'; // Default to descending for stats
            }
            currentSort[sortKey].column = column;
            
            // Update header indicators for this table only
            $(`#${tableId} .sortable`).removeClass('asc desc');
            $(this).addClass(currentSort[sortKey].direction);
            
            // Sort rows
            rows.sort(function(a, b) {
                let aVal, bVal;
                
                // Find the correct column index based on the data-column attribute
                const columnIndex = $(`#${tableId} .sortable[data-column="${column}"]`).index();
                
                aVal = parseFloat($(a).find('td').eq(columnIndex).data('value')) || 0;
                bVal = parseFloat($(b).find('td').eq(columnIndex).data('value')) || 0;
                
                if (currentSort[sortKey].direction === 'asc') {
                    return aVal - bVal;
                } else {
                    return bVal - aVal;
                }
            });
            
            // Re-append sorted rows and update ranking numbers
            table.empty().append(rows);
            updateRankingNumbers(tableId);
        });
    }
    
    // Function to update ranking numbers after sorting
    function updateRankingNumbers(tableId) {
        $(`#${tableId} tbody tr`).each(function(index) {
            $(this).find('td:first').text(index + 1);
        });
    }
    
    // Setup sorting for all tables
    setupSorting('scoringStatsTable', 'scoring');
    setupSorting('goalScorersTable', 'goals');
    setupSorting('assistProvidersTable', 'assists');
    setupSorting('pimsStatsTable', 'pims');
    
    // Team filtering functionality for all tables
    $('#teamFilter').change(function() {
        const selectedTeam = $(this).val();
        const scoringRows = $('#scoringStatsTable tbody tr');
        const goalRows = $('#goalScorersTable tbody tr');
        const assistRows = $('#assistProvidersTable tbody tr');
        const pimsRows = $('#pimsStatsTable tbody tr');
        
        function filterRows(rows, tableId) {
            if (selectedTeam === '') {
                // Show all rows
                rows.show();
            } else {
                // Hide/show rows based on team
                rows.each(function() {
                    const rowTeam = $(this).data('team');
                    if (rowTeam === selectedTeam) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            }
            // Update ranking numbers after filtering
            updateRankingNumbers(tableId);
        }
        
        filterRows(scoringRows, 'scoringStatsTable');
        filterRows(goalRows, 'goalScorersTable');
        filterRows(assistRows, 'assistProvidersTable');
        filterRows(pimsRows, 'pimsStatsTable');
    });
    
    // Statistics table toggle functionality
    $('.toggle-stats-visibility').on('click', function() {
        var $button = $(this);
        var targetBodySelector = $button.data('target-body');
        var $tableBody = $(targetBodySelector);
        
        $tableBody.find('tr.extra-stats-row').toggleClass('d-none');

        if ($button.text() === 'Alle anzeigen') {
            $button.text('Weniger anzeigen');
        } else {
            $button.text('Alle anzeigen');
        }
    });

    // Initial sort - all tables by their main stat (descending)
    $('#scoringStatsTable th[data-column="scorer_points"]').click(); // Points descending
    $('#goalScorersTable th[data-column="goals"]').click(); // Goals descending
    $('#assistProvidersTable th[data-column="assists"]').click(); // Assists descending
    $('#pimsStatsTable th[data-column="pims"]').click(); // PIMs descending
});
</script>
{% endblock %}
